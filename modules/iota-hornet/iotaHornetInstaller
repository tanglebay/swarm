#!/bin/bash

if [ "$iotaHornetReleaseVersion" = "v2" ] && [ ! -z "$iotaHornetReleaseVersion" ] && [[ $latestIotaHornetVersion =~ ^2.* ]]; then
    echo "IOTA HORNET INSTALLER" > /tmp/iotaHornetInstaller.log
    # General
    if ! id hornet >/dev/null 2>&1; then
        echo "-> Adde user \"hornet\"" >> /tmp/iotaHornetInstaller.log
        useradd --no-create-home --system hornet >/dev/null
    fi

    if [ ! -d "$iotaHornetHome" ]; then
        sudo mkdir -p $iotaHornetHome > /dev/null 2>&1
        sudo chown -R hornet:hornet $iotaHornetHome > /dev/null 2>&1
        echo "-> Create hornet home: $iotaHornetHome" >> /tmp/iotaHornetInstaller.log
    fi

    # Install GO
    if ! [ -x "$(command -v go)" ] > /dev/null 2>&1; then
        sudo snap install go --classic > /dev/null 2>&1
        echo "-> Install snap go package" >> /tmp/iotaHornetInstaller.log
    fi

    # Create Service
    if [ ! -f "/lib/systemd/system/iota-hornet.service" ]; then
        sudo cp -rf $swarmTemplates/app-service/iota-hornet.service /lib/systemd/system/iota-hornet.service > /dev/null 2>&1
        echo "-> Add new service file for IOTA Hornet" >> /tmp/iotaHornetInstaller.log
        if [ ! -f "/etc/systemd/system/multi-user.target.wants/iota-hornet.service" ]; then
            sudo systemctl enable iota-hornet > /dev/null 2>&1
            echo "-> Enable service for IOTA Hornet" >> /tmp/iotaHornetInstaller.log
        fi
        sudo systemctl daemon-reload
    fi

    if [ ! -f "/etc/default/iota-hornet" ]; then
        echo "OPTIONS=\"--config config_mainnet.json\"" > /etc/default/iota-hornet
        echo "-> Create default file for the IOTA Hornet service" >> /tmp/iotaHornetInstaller.log
    else
        iotaHornetDefaultCheck=$(cat /etc/default/iota-hornet)
        if [[ $iotaHornetDefaultCheck != *config_mainnet.json* ]]; then
            echo "OPTIONS=\"--config config_mainnet.json\"" > /etc/default/iota-hornet
            echo "-> Replace old config.json and set config_mainnet.json" >> /tmp/iotaHornetInstaller.log
        fi
    fi

    if [ -d "$iotaHornetHome" ]; then
        if [ ! -d "$iotaHornetHome/$iotaHornetNetwork" ]; then
            sudo -u hornet mkdir -p $iotaHornetHome/$iotaHornetNetwork > /dev/null 2>&1
            echo "-> Create new folder for db, snapshots and identity" >> /tmp/iotaHornetInstaller.log
        fi
        if [ -d "$iotaHornetHome/${iotaHornetNetwork}db" ]; then
            sudo -u hornet mv $iotaHornetHome/${iotaHornetNetwork}db $iotaHornetHome/$iotaHornetNetwork/database > /dev/null 2>&1
            echo "-> Move $iotaHornetNetwork database folder to new location: $iotaHornetHome/$iotaHornetNetwork/database" >> /tmp/iotaHornetInstaller.log
        fi
        if [ -d "$iotaHornetHome/p2pstore" ] && [ ! -d "$iotaHornetHome/$iotaHornetNetwork/p2pstore" ]; then
            sudo -u hornet mv $iotaHornetHome/p2pstore $iotaHornetHome/$iotaHornetNetwork/ > /dev/null 2>&1
            echo "-> Move $iotaHornetNetwork p2pstore folder to new location: $iotaHornetHome/$iotaHornetNetwork/p2pstore" >> /tmp/iotaHornetInstaller.log
        fi
        if [ -d "$iotaHornetHome/snapshots/$iotaHornetNetwork" ] && [ ! -d "$iotaHornetHome/$iotaHornetNetwork/snapshots" ]; then
            sudo -u hornet mv $iotaHornetHome/snapshots/$iotaHornetNetwork $iotaHornetHome/$iotaHornetNetwork/snapshots > /dev/null 2>&1
            echo "-> Move $iotaHornetNetwork snapshot folder to new location: $iotaHornetHome/$iotaHornetNetwork/snapshots" >> /tmp/iotaHornetInstaller.log
        fi
    fi

    ##############################################################################################################################################

    # Create dir if not exist
    sudo mkdir -p /tmp/iota-hornet > /dev/null 2>&1

    if [ "$osArchitecture" = "amd64" ]; then
        iotaHornetArchitecture="x86_64"
    fi
    if [ "$osArchitecture" = "arm64" ]; then
        iotaHornetArchitecture="ARM64"
    fi

    if [ ! -z "$iotaHornetArchitecture" ]; then
        # Download latest iota-hornet
        ( cd /tmp/iota-hornet/ ; sudo wget -q https://github.com/iotaledger/hornet/releases/download/v${latestIotaHornetVersion}/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz )
        echo "-> Downloading HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz" >> /tmp/iotaHornetInstaller.log
        if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz" ]; then
            iotaHornetDownloadChecksum=$(sudo shasum -a 256 /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz | awk '{ print $1 }')
            echo "-> Generating checksum of HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz: $iotaHornetDownloadChecksum" >> /tmp/iotaHornetInstaller.log
            # Download checksum
            ( cd /tmp/iota-hornet/ ; sudo wget -q https://github.com/iotaledger/hornet/releases/download/v${latestIotaHornetVersion}/checksums.txt )
            echo "-> Downloading checksum of HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz" >> /tmp/iotaHornetInstaller.log
            if [ -f "/tmp/iota-hornet/checksums.txt" ]; then
                iotaHornetChecksum=$(sudo grep "HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz" /tmp/iota-hornet/checksums.txt | awk '{ print $1 }')
                echo $iotaHornetChecksum > /tmp/iota-hornet.checksum
                echo "-> HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz checksum: $iotaHornetChecksum" >> /tmp/iotaHornetInstaller.log
            fi

            # Unzip archive
            if [ "$iotaHornetDownloadChecksum" = "$iotaHornetChecksum" ] && [ ! -z "$iotaHornetDownloadChecksum" ] && [ ! -z "$iotaHornetChecksum" ]; then
                echo "-> Checksum validation, done." >> /tmp/iotaHornetInstaller.log
                ( cd /tmp/iota-hornet ; sudo tar -xzf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz ) > /dev/null 2>&1
                echo "-> Unzip \"HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz\" archive" >> /tmp/iotaHornetInstaller.log
                # Copy binary
                if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/hornet" ]; then
                    iotaHornetStatus="$(systemctl show -p ActiveState --value iota-hornet)"
                    echo "-> Check status of hornet: $iotaHornetStatus " >> /tmp/iotaHornetInstaller.log
                    if [ "$iotaHornetStatus" = "active" ]; then
                        echo "-> Stop [IOTA] Hornet node" >> /tmp/iotaHornetInstaller.log
                        sudo systemctl stop iota-hornet > /dev/null 2>&1
                    fi

                    echo "-> Copy [IOTA] Hornet binary file: /usr/bin/iota-hornet" >> /tmp/iotaHornetInstaller.log
                    sudo cp -rf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/hornet /usr/bin/iota-hornet > /dev/null 2>&1
                    echo "-> Set permissions: /usr/bin/iota-hornet" >> /tmp/iotaHornetInstaller.log
                    sudo chmod +x /usr/bin/iota-hornet > /dev/null 2>&1
                    newIotaHornetBinary=true
                else
                    echo "-> Hornet binary file not found" >> /tmp/iotaHornetInstaller.log
                fi
            fi
        else
            echo "-> ERROR - Downloaded file not found" >> /tmp/iotaHornetInstaller.log
        fi

    fi


    ##############################################################################################################################################

    if [ "$newIotaHornetBinary" = "true" ]; then
        ### Mainnet Config
        if [ "$iotaHornetNetwork" = "mainnet" ]; then
            if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/config_defaults.json" ]; then
                echo "-> Copy new config file: $iotaHornetHome/config_mainnet.json" >> /tmp/iotaHornetInstaller.log
                sudo cp -rf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/config_defaults.json $iotaHornetHome/config_mainnet.json > /dev/null 2>&1
                if [ -s "$iotaHornetHome/config_mainnet.json" ]; then
                    newIotaHornetConfig=true
                fi
            else
                echo "-> New config file not found. Downloading new config from GitHub. Repository: Hornet, Branch: production" >> /tmp/iotaHornetInstaller.log
                sudo -u hornet wget -q -O $iotaHornetHome/config_mainnet.json https://raw.githubusercontent.com/iotaledger/hornet/production/config_defaults.json
                iotaHornetConfigMainnetCheck=$(cat $iotaHornetHome/config_mainnet.json)
                if [ -f "$iotaHornetHome/config_mainnet.json" ] && [ ! -z "$iotaHornetConfigMainnetCheck" ]; then
                    newIotaHornetConfig=true
                fi
                unset iotaHornetConfigMainnetCheck
            fi
        fi
    fi

    ##############################################################################################################################################

    if [ "$newIotaHornetConfig" = "true" ]; then
        # Run installer modules
        echo "-> Set permissions for [IOTA] Hornet" >> /tmp/iotaHornetInstaller.log
        sudo chown -R hornet:hornet $iotaHornetHome > /dev/null 2>&1
        sudo chmod 644 $iotaHornetHome/*.json > /dev/null 2>&1

        restartIotaHornet=true
        iotaHornetUpdated=true
        echo "-> Hornet v${latestIotaHornetVersion} installation completed." >> /tmp/iotaHornetInstaller.log
    fi

    # Remove temporary files
    if [ -d "/tmp/iota-hornet" ]; then
        echo "-> Clean up tmp folder: /tmp/iota-hornet"
        sudo rm -rf /tmp/iota-hornet > /dev/null 2>&1
    fi

    echo "-> Exit installer."
    unset newIotaHornetBinary newIotaHornetConfig iotaHornetDownloadChecksum
else
    # General
    if ! id hornet >/dev/null 2>&1; then
        useradd --no-create-home --system hornet >/dev/null
    fi

    if [ ! -d "$iotaHornetHome" ]; then
        sudo mkdir -p $iotaHornetHome > /dev/null 2>&1
        sudo chown -R hornet:hornet $iotaHornetHome > /dev/null 2>&1
    fi

    # Install GO
    if ! [ -x "$(command -v go)" ] > /dev/null 2>&1; then
        sudo snap install go --classic > /dev/null 2>&1
    fi

    # Create Service
    if [ ! -f "/lib/systemd/system/iota-hornet.service" ]; then
        sudo cp -rf $swarmTemplates/app-service/iota-hornet.service /lib/systemd/system/iota-hornet.service > /dev/null 2>&1
        if [ ! -f "/etc/default/iota-hornet" ]; then
            if [ "$iotaHornetNetwork" = "mainnet" ]; then 
                echo "OPTIONS=\"--config config.json\"" > /etc/default/iota-hornet
            fi
            if [ "$iotaHornetNetwork" = "comnet" ]; then 
                echo "OPTIONS=\"--config config-comnet.json\"" > /etc/default/iota-hornet
            fi
            if [ "$iotaHornetNetwork" = "devnet" ]; then 
                echo "OPTIONS=\"--config config-devnet.json\"" > /etc/default/iota-hornet
            fi
        fi
        if [ ! -f "/etc/systemd/system/multi-user.target.wants/iota-hornet.service" ]; then
            sudo systemctl enable iota-hornet > /dev/null 2>&1
        fi
        sudo systemctl daemon-reload
    fi

    ##############################################################################################################################################

    # Create dir if not exist
    sudo mkdir -p /tmp/iota-hornet > /dev/null 2>&1

    if [ "$osArchitecture" = "amd64" ]; then
        iotaHornetArchitecture="x86_64"
    fi
    if [ "$osArchitecture" = "arm64" ]; then
        iotaHornetArchitecture="ARM64"
    fi

    if [ ! -z "$iotaHornetArchitecture" ]; then
        # Download latest hornet
        ( cd /tmp/iota-hornet/ ; sudo wget -q https://github.com/iotaledger/hornet/releases/download/v${latestIotaHornetVersion}/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz )
        if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz" ]; then
            iotaHornetDownloadChecksum=$(sudo shasum -a 256 /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz | awk '{ print $1 }')
        fi
        # Download checksum
        ( cd /tmp/iota-hornet/ ; sudo wget -q https://github.com/iotaledger/hornet/releases/download/v${latestIotaHornetVersion}/checksums.txt )
        if [ -f "/tmp/iota-hornet/checksums.txt" ]; then
            iotaHornetChecksum=$(sudo grep "HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz" /tmp/iota-hornet/checksums.txt | awk '{ print $1 }')
            echo $iotaHornetChecksum > /tmp/iota-hornet.checksum
        fi

        # Unzip archive
        if [ "$iotaHornetDownloadChecksum" = "$iotaHornetChecksum" ] && [ ! -z "$iotaHornetDownloadChecksum" ] && [ ! -z "$iotaHornetChecksum" ]; then
            ( cd /tmp/iota-hornet ; sudo tar -xzf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture.tar.gz ) > /dev/null 2>&1

            # Copy binary
            if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/hornet" ]; then
                iotaHornetStatus="$(systemctl show -p ActiveState --value iota-hornet)"
                if [ "$iotaHornetStatus" = "active" ]; then
                    sudo systemctl stop iota-hornet > /dev/null 2>&1
                fi

                sudo cp -rf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/hornet /usr/bin/iota-hornet > /dev/null 2>&1
                sudo chmod +x /usr/bin/iota-hornet > /dev/null 2>&1
                newIotaHornetBinary=true
            fi
        fi
    fi


    ##############################################################################################################################################

    if [ "$newIotaHornetBinary" = "true" ]; then
        ### Mainnet Config
        if [ "$iotaHornetNetwork" = "mainnet" ]; then
            if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/config.json" ]; then
                sudo cp -rf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/config.json $iotaHornetHome/config.json > /dev/null 2>&1
                if [ -s "$iotaHornetHome/config.json" ]; then
                    newIotaHornetConfig=true
                fi
            fi
        fi

        ### Devnet Config
        if [ "$iotaHornetNetwork" = "devnet" ]; then
            if [ -f "/tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/config-devnet.json" ]; then
                sudo cp -rf /tmp/iota-hornet/HORNET-${latestIotaHornetVersion}_Linux_$iotaHornetArchitecture/config-devnet.json $iotaHornetHome/config-devnet.json > /dev/null 2>&1
                if [ -s "$iotaHornetHome/config-devnet.json" ]; then
                    newIotaHornetConfig=true
                fi
            fi
        fi
    fi

    ##############################################################################################################################################

    if [ "$newIotaHornetConfig" = "true" ]; then
        # Run installer modules
        sudo chown -R hornet:hornet $iotaHornetHome > /dev/null 2>&1
        sudo chmod 644 $iotaHornetHome/*.json > /dev/null 2>&1

        restartIotaHornet=true
        iotaHornetUpdated=true
    fi

    # Remove temporary files
    sudo rm -rf /tmp/iota-hornet > /dev/null 2>&1


    unset newIotaHornetBinary newIotaHornetConfig iotaHornetDownloadChecksum
fi