#!/bin/bash

if [ "$(printf '%s\n' "$iotaHornetStardustMinVersion" "$iotaHornetVersion" | sort -V | head -n1)" != "$iotaHornetStardustMinVersion" ] && [ ! -z "$iotaHornetVersion" ]; then
    parser="$(jq '.p2p.bindMultiAddresses' $iotaHornetHome/$iotaHornetConfig.json)"
    parser="$(echo $parser | tr -d '[]":/. ')"

    if [ -n "$iotaHornetGossipPort" ] && [ "$iotaHornetGossipPort" -gt 0 ] && [[ $parser != *$iotaHornetGossipPort* ]] 2>/dev/null; then
        sudo jq '.p2p.bindMultiAddresses = ["/ip4/0.0.0.0/tcp/'$iotaHornetGossipPort'"]' $iotaHornetHome/$iotaHornetConfig.json|sponge $iotaHornetHome/$iotaHornetConfig.json
        sudo jq '.p2p.bindMultiAddresses |= .+ ["/ip6/::/tcp/'$iotaHornetGossipPort'"]' $iotaHornetHome/$iotaHornetConfig.json|sponge $iotaHornetHome/$iotaHornetConfig.json
        restartIotaHornet=true
        echo "iotaHornetGossipPort" >> /tmp/iotaHornetParsing
    fi
else
    parser="$(jq '.p2p.bindMultiAddresses' $iotaHornetHome/$iotaHornetConfig.json)"
    parser="$(echo $parser | tr -d '[]":/. ')"

    if [ -n "$iotaHornetGossipPort" ] && [ "$iotaHornetGossipPort" -gt 0 ] && [[ $parser != *$iotaHornetGossipPort* ]] 2>/dev/null; then
        sudo jq '.p2p.bindMultiAddresses = ["/ip4/0.0.0.0/tcp/'$iotaHornetGossipPort'"]' $iotaHornetHome/$iotaHornetConfig.json|sponge $iotaHornetHome/$iotaHornetConfig.json
        sudo jq '.p2p.bindMultiAddresses |= .+ ["/ip6/::/tcp/'$iotaHornetGossipPort'"]' $iotaHornetHome/$iotaHornetConfig.json|sponge $iotaHornetHome/$iotaHornetConfig.json
        restartIotaHornet=true
        echo "iotaHornetGossipPort" >> /tmp/iotaHornetParsing
    fi
fi
