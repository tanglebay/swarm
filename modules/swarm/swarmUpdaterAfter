#!/bin/bash

# Load new env
source /var/lib/swarm/environment

sudo chmod +x $swarmHome/swarm $swarmPlugins/watchdog > /dev/null 2>&1

source $swarmModules/swarmParser

( crontab -l | grep -v -F "$watchdogCronCmd" ) | crontab - > /dev/null 2>&1
( crontab -l | grep -v -F "$watchdogCronCmd" ; echo "$watchdogCronJob" ) | crontab - > /dev/null 2>&1

# Remove hornet apt source
if [ -f "/etc/apt/sources.list.d/hornet.list" ] || [ -f "/etc/apt/sources.list.d/hornet.list.distUpgrade" ]; then
    sudo rm -rf /etc/apt/sources.list.d/hornet* > /dev/null 2>&1
    sudo apt-get -qq update > /dev/null 2>&1
fi

source $swarmModules/swarmUpdaterAppService

for swarmApp in ${swarmApps[@]}
do
    source $swarmModules/swarmAppVars
    if [ -f "/usr/bin/$swarmApp" ]; then
        swarmAppModules=${swarmAppPrefix}Modules
        source ${!swarmAppModules}/${swarmAppPrefix}Parser
        swarmAppRestart=restart${swarmAppPrefix}
        if [ "${!swarmAppRestart}" = "true" ]; then
            sudo systemctl restart $swarmApp > /dev/null 2>&1
            if [ "$swarmApp" = "shimmer-hornet" ]; then
                sleep 10
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                        sudo systemctl restart shimmer-inx-$shimmerInxPlugin 2>/dev/null
                    fi
                done
                unset restartShimmerHornet shimmerInxPlugin
            fi
        fi
        unset swarmAppRestart swarmAppModules
    fi
    unset swarmAppPrefix
done
unset swarmApp

source $proxyModules/proxyAutomaticDeployment

source $proxyModules/proxySwarmEndpoint
