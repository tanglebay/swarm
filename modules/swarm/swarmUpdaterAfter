#!/bin/bash

sudo chmod +x $swarmHome/swarm $swarmHome/watchdog > /dev/null 2>&1

source $swarmModule/swarmConfigs
source $swarmModule/swarmParser

( crontab -l | grep -v -F "$watchdogCronCmd" ) | crontab - > /dev/null 2>&1
( crontab -l | grep -v -F "$watchdogCronCmd" ; echo "$watchdogCronJob" ) | crontab - > /dev/null 2>&1

# Remove hornet apt source
if [ -f "/etc/apt/sources.list.d/hornet.list" ] || [ -f "/etc/apt/sources.list.d/hornet.list.distUpgrade" ]; then
    sudo rm -rf /etc/apt/sources.list.d/hornet* > /dev/null 2>&1
    sudo apt-get -qq update > /dev/null 2>&1
fi

source $swarmModule/swarmUpdaterAppService

for swarmApp in ${swarmApps[@]}
do
    if [ -f "/usr/bin/$swarmApp" ]; then
        source $swarmModule/swarmAppVars
        # source ${!swarmAppModule}/${swarmAppPrefix}Parser
        swarmAppRestart=restart${swarmAppPrefix^}
        if [ "${!swarmAppRestart}" = "true" ]; then
            if [ ! -f "/tmp/$swarmApp.lock" ]; then
                sudo touch /tmp/$swarmApp.lock > /dev/null 2>&1
            fi
            if [ "$swarmApp" = "shimmer-hornet" ]; then
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                        sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                    fi
                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                        sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                    fi
                done
                unset shimmerInxPlugin
                sudo systemctl restart $swarmApp > /dev/null 2>&1
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                        sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                    fi
                    if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                        sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                    fi
                done
                unset shimmerInxPlugin restartShimmerHornet
            else
                sudo systemctl restart $swarmApp > /dev/null 2>&1
            fi
            if [ -f "/tmp/$swarmApp.lock" ]; then
                sudo rm -rf /tmp/$swarmApp.lock > /dev/null 2>&1
            fi
        fi
        unset swarmAppRestart swarmAppModule
    fi
    unset swarmAppPrefix
done
unset swarmApp

source $proxyModule/proxyAutomaticDeployment

source $proxyModule/proxySwarmEndpoint

# Set updated var
swarmUpdated=true
