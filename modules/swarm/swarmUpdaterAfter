#!/bin/bash

sudo chmod +x $swarmHome/swarm $swarmHome/watchdog > /dev/null 2>&1

source $swarmModule/swarmConfigs
source $swarmModule/swarmParser

if [ -f "/tmp/watchdog.state" ]; then
    sudo rm -rf /tmp/watchdog.state > /dev/null 2>&1
fi

( crontab -l | grep -v -F "/var/lib/swarm/plugins/watchdog" ) | crontab - > /dev/null 2>&1
( crontab -l | grep -v -F "$watchdogCronCmd" ) | crontab - > /dev/null 2>&1
( crontab -l | grep -v -F "$watchdogCronCmd" ; echo "$watchdogCronJob" ) | crontab - > /dev/null 2>&1

source $swarmModule/swarmUpdaterAppService

for swarmApp in ${swarmApps[@]}
do
    if [ -f "/usr/bin/$swarmApp" ]; then
        source $swarmModule/swarmAppVars
        source ${!swarmAppModule}/${swarmAppPrefix}Parser
        swarmAppRestart=restart${swarmAppPrefix^}
        if [ "${!swarmAppRestart}" = "true" ]; then
            if [ ! -f "/tmp/$swarmApp.lock" ]; then
                sudo touch /tmp/$swarmApp.lock > /dev/null 2>&1
            fi
            if [ "$swarmApp" = "iota-hornet" ]; then
                for iotaInxPlugin in ${iotaInxPlugins[@]}
                do
                    if [ -f "/usr/bin/iota-inx-$iotaInxPlugin" ]; then
                        if [ ! -f "/tmp/iota-inx-$iotaInxPlugin.lock" ]; then
                            sudo touch /tmp/iota-inx-$iotaInxPlugin.lock > /dev/null 2>&1
                        fi
                        sudo systemctl stop iota-inx-$iotaInxPlugin 2>/dev/null
                    fi
                done
                unset iotaInxPlugin
                sudo systemctl restart $swarmApp > /dev/null 2>&1
                for iotaInxPlugin in ${iotaInxPlugins[@]}
                do
                    if [ -f "/usr/bin/iota-inx-$iotaInxPlugin" ]; then
                        sudo systemctl start iota-inx-$iotaInxPlugin 2>/dev/null
                    fi
                    if [ -f "/tmp/iota-inx-$iotaInxPlugin.lock" ]; then
                        sudo rm -rf /tmp/iota-inx-$iotaInxPlugin.lock > /dev/null 2>&1
                    fi
                done
                if [ -z "$(ls -A $iotaHornetHome/${iotaHornetNetwork}db)" ]; then
                    sudo rm -rf $iotaHornetHome/${iotaHornetNetwork}db > /dev/null 2>&1
                fi
                unset iotaInxPlugin restartIotaHornet
            fi
            if [ "$swarmApp" = "shimmer-hornet" ]; then
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                        if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                            sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                        fi
                        sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                    fi
                done
                unset shimmerInxPlugin
                sudo systemctl restart $swarmApp > /dev/null 2>&1
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                        sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                        if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                            sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                        fi
                    fi
                done
                unset shimmerInxPlugin restartShimmerHornet
            fi
            if [[ $swarmApp != *hornet* ]]; then
                sudo systemctl restart $swarmApp > /dev/null 2>&1
            fi
            if [ -f "/tmp/$swarmApp.lock" ]; then
                sudo rm -rf /tmp/$swarmApp.lock > /dev/null 2>&1
            fi
        fi
        unset swarmAppRestart swarmAppModule
    fi
    unset swarmAppPrefix
done
unset swarmApp

if [ -f "/usr/bin/goshimmer" ]; then
    source $swarmModule/swarmGoshimmerRemoval
fi

source $proxyModule/proxyAutomaticDeployment

source $proxyModule/proxySwarmEndpoint

# Set updated var
swarmUpdated=true
