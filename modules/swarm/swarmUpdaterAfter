#!/bin/bash

# Load new env
source /var/lib/swarm/environment

sudo chmod +x $swarmHome/swarm $swarmPlugins/watchdog > /dev/null 2>&1

source $swarmModule/swarmParser

( crontab -l | grep -v -F "$watchdogCronCmd" ) | crontab - > /dev/null 2>&1
( crontab -l | grep -v -F "$watchdogCronCmd" ; echo "$watchdogCronJob" ) | crontab - > /dev/null 2>&1

# Remove hornet apt source
if [ -f "/etc/apt/sources.list.d/hornet.list" ] || [ -f "/etc/apt/sources.list.d/hornet.list.distUpgrade" ]; then
    sudo rm -rf /etc/apt/sources.list.d/hornet* > /dev/null 2>&1
    sudo apt-get -qq update > /dev/null 2>&1
fi

source $swarmModule/swarmUpdaterAppService

for swarmApp in ${swarmApps[@]}
do
    source $swarmModule/swarmAppVars
    if [ -f "/usr/bin/$swarmApp" ]; then
        swarmAppModule=${swarmAppPrefix}Module
        source ${!swarmAppModule}/${swarmAppPrefix}Parser
        swarmAppRestart=restart${swarmAppPrefix^}
        if [ "${!swarmAppRestart}" = "true" ]; then
            if [ "$swarmApp" = "shimmer-hornet" ]; then
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ -f "/usr/bin/shimmer-$shimmerInxPlugin" ]; then
                        sudo systemctl stop shimmer-$shimmerInxPlugin 2>/dev/null
                    fi
                done
                unset shimmerInxPlugin
                sudo systemctl restart $swarmApp > /dev/null 2>&1
                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                do
                    if [ -f "/usr/bin/shimmer-$shimmerInxPlugin" ]; then
                        sudo systemctl start shimmer-$shimmerInxPlugin 2>/dev/null
                    fi
                done
                unset shimmerInxPlugin restartShimmerHornet
            else
                sudo systemctl restart $swarmApp > /dev/null 2>&1
            fi
        fi
        unset swarmAppRestart swarmAppModule
    fi
    unset swarmAppPrefix
done
unset swarmApp

source $proxyModule/proxyAutomaticDeployment

source $proxyModule/proxySwarmEndpoint
