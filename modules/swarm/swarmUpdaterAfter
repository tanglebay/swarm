#!/bin/bash

# Load new env
source /var/lib/swarm/environment

sudo chmod +x $swarmHome/swarm $swarmPlugins/watchdog > /dev/null 2>&1

source $swarmModules/swarmParser

( crontab -l | grep -v -F "$watchdogCronCmd" ) | crontab - > /dev/null 2>&1
( crontab -l | grep -v -F "$watchdogCronCmd" ; echo "$watchdogCronJob" ) | crontab - > /dev/null 2>&1

# Remove hornet apt source
if [ -f "/etc/apt/sources.list.d/hornet.list" ] || [ -f "/etc/apt/sources.list.d/hornet.list.distUpgrade" ]; then
    sudo rm -rf /etc/apt/sources.list.d/hornet* > /dev/null 2>&1
    sudo apt-get -qq update > /dev/null 2>&1
fi

if [ -f "/usr/bin/iota-hornet" ]; then
    source $iotaHornetModules/iotaHornetParser
    if [ "$restartIotaHornet" = "true" ]; then
        sudo systemctl restart iota-hornet > /dev/null 2>&1
        unset restartIotaHornet
    fi
fi
if [ -f "/usr/bin/shimmer-hornet" ]; then
    source $shimmerHornetModules/shimmerHornetParser
    if [ "$restartShimmerHornet" = "true" ]; then
        sudo systemctl restart shimmer-hornet > /dev/null 2>&1
        unset restartShimmerHornet
    fi
fi
if [ -f "/usr/bin/iota-bee" ]; then
    iotaBeeIgnorePeersUpdate=true
    source $iotaBeeModules/beeParser
    if [ "$restartBee" = "true" ]; then
        sudo systemctl restart iota-bee > /dev/null 2>&1
        unset restartIotaBee
    fi
    unset iotaBeeIgnorePeersUpdate
fi
if [ -f "/usr/bin/shimmer-bee" ]; then
    shimmerBeeIgnorePeersUpdate=true
    source $shimmerBeeModules/shimmerBeeParser
    if [ "$restartShimmerBee" = "true" ]; then
        sudo systemctl restart shimmer-bee > /dev/null 2>&1
        unset restartShimmerBee
    fi
    unset shimmerBeeIgnorePeersUpdate
fi
if [ -f "/usr/bin/goshimmer" ]; then
    source $goshimmerModules/goshimmerParser
    if [ "$restartGoshimmer" = "true" ]; then
        sudo systemctl restart goshimmer > /dev/null 2>&1
        unset restartGoshimmer
    fi
fi
if [ -f "/usr/bin/wasp" ]; then
    source $waspModules/waspParser
    if [ "$restartWasp" = "true" ]; then
        sudo systemctl restart wasp > /dev/null 2>&1
        unset restartWasp
    fi
fi
if [ -f "/usr/bin/shimmer-inx-dashboard" ]; then
    source $shimmerInxDashboardModules/shimmerInxDashboardParser
    if [ "$restartShimmerInxDashboard" = "true" ]; then
        sudo systemctl restart shimmer-inx-dashboard > /dev/null 2>&1
        unset restartShimmerInxDashboard
    fi
fi
if [ -f "/usr/bin/shimmer-inx-indexer" ]; then
    source $shimmerInxIndexerModules/shimmerInxIndexerParser
    if [ "$restartShimmerInxIndexer" = "true" ]; then
        sudo systemctl restart shimmer-inx-indexer > /dev/null 2>&1
        unset restartShimmerInxIndexer
    fi
fi
if [ -f "/usr/bin/shimmer-inx-mqtt" ]; then
    source $shimmerInxMqttModules/shimmerInxMqttParser
    if [ "$restartShimmerInxMqtt" = "true" ]; then
        sudo systemctl restart shimmer-inx-mqtt > /dev/null 2>&1
        unset restartShimmerInxMqtt
    fi
fi
if [ -f "/usr/bin/shimmer-inx-participation" ]; then
    source $shimmerInxParticipationModules/shimmerInxParticipationParser
    if [ "$restartShimmerInxParticipation" = "true" ]; then
        sudo systemctl restart shimmer-inx-participation > /dev/null 2>&1
        unset restartShimmerInxParticipation
    fi
fi

source $proxyModules/proxyAutomaticDeployment

source $proxyModules/proxySwarmEndpoint
