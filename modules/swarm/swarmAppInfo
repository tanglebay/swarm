#!/bin/bash

source $swarmConfigs/latest-versions.cfg

# Get Service Status
if [ -f "/usr/bin/hornet" ]; then
    hornetStatus="$(systemctl show -p ActiveState --value hornet)"
fi
if [ -f "/usr/bin/hornet-shimmer" ]; then
    shimmerHornetStatus="$(systemctl show -p ActiveState --value hornet-shimmer)"
fi
if [ -f "/usr/bin/bee" ]; then
    beeStatus="$(systemctl show -p ActiveState --value bee)"
fi
if [ -f "/usr/bin/bee-shimmer" ]; then
    shimmerBeeStatus="$(systemctl show -p ActiveState --value bee-shimmer)"
fi
if [ -f "/usr/bin/goshimmer" ]; then
    goshimmerStatus="$(systemctl show -p ActiveState --value goshimmer)"
fi
if [ -f "/usr/bin/wasp" ]; then
    waspStatus="$(systemctl show -p ActiveState --value wasp)"
fi

if [ -f "/usr/bin/iota-inx-indexer" ]; then
    iotaInxIndexerStatus="$(systemctl show -p ActiveState --value iota-inx-indexer)"
fi
if [ -f "/usr/bin/iota-inx-mqtt" ]; then
    iotaInxMqttStatus="$(systemctl show -p ActiveState --value iota-inx-mqtt)"
fi
if [ -f "/usr/bin/iota-inx-participation" ]; then
    iotaInxParticipationStatus="$(systemctl show -p ActiveState --value iota-inx-participation)"
fi

if [ -f "/usr/bin/shimmer-inx-indexer" ]; then
    shimmerInxIndexerStatus="$(systemctl show -p ActiveState --value shimmer-inx-indexer)"
fi
if [ -f "/usr/bin/shimmer-inx-mqtt" ]; then
    shimmerInxMqttStatus="$(systemctl show -p ActiveState --value shimmer-inx-mqtt)"
fi
if [ -f "/usr/bin/shimmer-inx-participation" ]; then
    shimmerInxParticipationStatus="$(systemctl show -p ActiveState --value shimmer-inx-participation)"
fi


# Hornet Version
if [ -f "/usr/bin/hornet" ]; then
    hornetVersion=$(/usr/bin/hornet -v | awk '{ print $2 }')
    if [ -z "$hornetVersion" ]; then
        hornetVersion="N/A"
    else
        if [ "$hornetVersion" != "$latestHornetVersion" ] && [ ! -z "$latestHornetVersion" ]; then
            hornetVersion="$hornetVersion (new version \"v$latestHornetVersion\" available!)"
        fi
    fi
else
    hornetVersion="N/A"
fi

# Hornet Shimmer Version
if [ -f "/usr/bin/hornet-shimmer" ]; then
    shimmerHornetVersion=$(/usr/bin/hornet-shimmer -v | awk '{ print $2 }')
    if [ -z "$shimmerHornetVersion" ]; then
        shimmerHornetVersion="N/A"
    else
        if [ "$shimmerHornetVersion" != "$latestShimmerHornetVersion" ] && [ ! -z "$latestShimmerHornetVersion" ]; then
            shimmerHornetVersion="$shimmerHornetVersion (new version \"v$latestShimmerHornetVersion\" available!)"
        fi
    fi
else
    shimmerHornetVersion="N/A"
fi

# Bee version
if [ -f "/usr/bin/bee" ]; then
    beeVersion=$(/usr/bin/bee -v | tr -d 'v"')
    if [[ $beeVersion = *rc[0-9]* ]]; then
        beeVersion=$(echo $beeVersion | cut -f1,2 -d"-")
    else
        beeVersion=$(echo $beeVersion | cut -f1 -d"-")
    fi
    if [ -z "$beeVersion" ]; then
        beeVersion="N/A"
    else
        if [ "$beeVersion" != "$latestBeeVersion" ] && [ ! -z "$latestBeeVersion" ]; then
            beeVersion="$beeVersion (new version \"v$latestBeeVersion\" available!"
        fi
    fi
else
    beeVersion="N/A"
fi

# Bee Shimmer version
if [ -f "/usr/bin/shimmer-bee" ]; then
    shimmerBeeVersion=$(/usr/bin/shimmer-bee -v | tr -d 'v"')
    if [[ $shimmerBeeVersion = *rc[0-9]* ]]; then
        shimmerBeeVersion=$(echo $shimmerBeeVersion | cut -f1,2 -d"-")
    else
        shimmerBeeVersion=$(echo $shimmerBeeVersion | cut -f1 -d"-")
    fi
    if [ -z "$shimmerBeeVersion" ]; then
        shimmerBeeVersion="N/A"
    else
        if [ "$shimmerBeeVersion" != "$latestShimmerBeeVersion" ] && [ ! -z "$latestShimmerBeeVersion" ]; then
            shimmerBeeVersion="$shimmerBeeVersion (new version \"v$latestShimmerBeeVersion\" available!"
        fi
    fi
else
    shimmerBeeVersion="N/A"
fi

# GoShimmer version
if [ -f "/usr/bin/goshimmer" ]; then
    goshimmerVersion=$(cd $goshimmerHome ; /usr/bin/goshimmer -v | awk '{print $2}' | tr -d 'v')
    if [ -z "$goshimmerVersion" ]; then
        goshimmerVersion="N/A"
    else
        if [ "$goshimmerVersion" != "$latestGoshimmerVersion" ] && [ ! -z "$latestGoshimmerVersion" ]; then
            goshimmerVersion="$goshimmerVersion (new version \"v$latestGoshimmerVersion\" available!"
        fi
    fi
else
    goshimmerVersion="N/A"
fi

# Wasp version
if [ -f "/usr/bin/wasp" ]; then
    waspVersion=$(cd $waspHome ; /usr/bin/wasp -v | awk '{print $2}' | tr -d 'v')
    if [ -z "$waspVersion" ]; then
        waspVersion="N/A"
    else
        if [ "$waspVersion" != "$latestWaspVersion" ] && [ ! -z "$latestWaspVersion" ]; then
            waspVersion="$waspVersion (new version \"v$latestWaspVersion\" available!"
        fi
    fi
else
    waspVersion="N/A"
fi

# INX-Indexer version
if [ -f "/usr/bin/shimmer-inx-indexer" ]; then
    shimmerInxIndexerVersion=$(cd $shimmerInxIndexerHome ; /usr/bin/shimmer-inx-indexer -v | awk '{print $2}' | tr -d 'v')
    if [ -z "$shimmerInxIndexerVersion" ]; then
        shimmerInxIndexerVersion="N/A"
    else
        if [ "$shimmerInxIndexerVersion" != "$latestShimmerInxIndexerVersion" ] && [ ! -z "$latestShimmerInxIndexerVersion" ]; then
            shimmerInxIndexerVersion="$shimmerInxIndexerVersion (new version \"v$latestShimmerInxIndexerVersion\" available!"
        fi
    fi
else
    shimmerInxIndexerVersion="N/A"
fi

# INX-MQTT version
if [ -f "/usr/bin/shimmer-inx-mqtt" ]; then
    shimmerInxMqttVersion=$(cd $shimmerInxMqttHome ; /usr/bin/shimmer-inx-mqtt -v | awk '{print $2}' | tr -d 'v')
    if [ -z "$shimmerInxMqttVersion" ]; then
        shimmerInxMqttVersion="N/A"
    else
        if [ "$shimmerInxMqttVersion" != "$latestShimmerInxMqttVersion" ] && [ ! -z "$latestShimmerInxMqttVersion" ]; then
            shimmerInxMqttVersion="$shimmerInxMqttVersion (new version \"v$latestShimmerInxMqttVersion\" available!"
        fi
    fi
else
    shimmerInxMqttVersion="N/A"
fi

# INX-Participation version
if [ -f "/usr/bin/shimmer-inx-participation" ]; then
    shimmerInxParticipationVersion=$(cd $shimmerInxParticipationHome ; /usr/bin/shimmer-inx-participation -v | awk '{print $2}' | tr -d 'v')
    if [ -z "$shimmerInxParticipationVersion" ]; then
        shimmerInxParticipationVersion="N/A"
    else
        if [ "$shimmerInxParticipationVersion" != "$latestShimmerInxParticipationVersion" ] && [ ! -z "$latestShimmerInxParticipationVersion" ]; then
            shimmerInxParticipationVersion="$shimmerInxParticipationVersion (new version \"v$latestShimmerInxParticipationVersion\" available!"
        fi
    fi
else
    shimmerInxParticipationVersion="N/A"
fi

# Hornet DB size
if [ -d "$hornetHome/${hornetNetwork}db" ]; then
    getCurrentDbSize="$(du -sb $hornetHome/${hornetNetwork}db | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentHornetDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentHornetDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentHornetDbSize="N/A"
fi

# Hornet Shimmer DB size
if [ -d "$shimmerHornetHome/$shimmerHornetNetwork/database" ]; then
    getCurrentDbSize="$(du -sb $shimmerHornetHome/$shimmerHornetNetwork/database | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentShimmerHornetDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentShimmerHornetDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentShimmerHornetDbSize="N/A"
fi

# Bee DB size
if [ -d "$beeHome/storage" ]; then
    getCurrentDbSize="$(du -sb $beeHome/storage | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentBeeDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentBeeDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentBeeDbSize="N/A"
fi

# Bee Shimmer DB size
if [ -d "$shimmerBeeHome/storage" ]; then
    getCurrentDbSize="$(du -sb $shimmerBeeHome/storage | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentShimmerBeeDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentShimmerBeeDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentShimmerBeeDbSize="N/A"
fi

# Goshimmer DB size
if [ -d "$goshimmerHome/mainnetdb" ]; then
    getCurrentDbSize="$(du -sb $goshimmerHome/mainnetdb | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentGoshimmerDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentGoshimmerDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentGoshimmerDbSize="N/A"
fi

# WASP DB size
if [ -d "$waspHome/waspdb" ]; then
    getCurrentDbSize="$(du -sb $waspHome/waspdb | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentWaspDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentWaspDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentWaspDbSize="N/A"
fi

# INX-Indexer DB size
if [ -d "$shimmerInxIndexerHome/database" ]; then
    getCurrentDbSize="$(du -sb $shimmerInxIndexerHome/database | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentShimmerInxIndexerDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentShimmerInxIndexerDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentShimmerInxIndexerDbSize="N/A"
fi

# INX-Participation DB size
if [ -d "$shimmerInxParticipationHome/database" ]; then
    getCurrentDbSize="$(du -sb $shimmerInxParticipationHome/database | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ $getCurrentDbSizeInMb -gt 999 ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentShimmerInxParticipationDbSize="${getCurrentDbSizeInGb} GB"
    else
        currentShimmerInxParticipationDbSize="${getCurrentDbSizeInMb} MB"
    fi
else
    currentShimmerInxParticipationDbSize="N/A"
fi

if [ -f "/usr/bin/hornet" ]; then
    hornetAppInfo="Hornet (IOTA)\nStatus: $hornetStatus\nVersion: $hornetVersion\nDatabase: $currentHornetDbSize\n\n"
fi

if [ -f "/usr/bin/hornet-shimmer" ]; then
    shimmerHornetAppInfo="Hornet (Shimmer)\nStatus: $shimmerHornetStatus\nVersion: $shimmerHornetVersion\nDatabase: $currentShimmerHornetDbSize\n\n"
fi

if [ -f "/usr/bin/bee" ]; then
    beeAppInfo="Bee (IOTA)\nStatus: $beeStatus\nVersion: $beeVersion\nDatabase: $currentBeeDbSize\n\n"
fi

if [ -f "/usr/bin/bee-shimmer" ]; then
    shimmerBeeAppInfo="Bee (Shimmer)\nStatus: $shimmerBeeStatus\nVersion: $shimmerBeeVersion\nDatabase: $currentShimmerBeeDbSize\n\n"
fi

if [ -f "/usr/bin/goshimmer" ]; then
    goshimmerAppInfo="GoShimmer\nStatus: $goshimmerStatus\nVersion: $goshimmerVersion\nDatabase: $currentGoshimmerDbSize\n\n"
fi

if [ -f "/usr/bin/wasp" ]; then
    waspAppInfo="WASP\nStatus: $waspStatus\nVersion: $waspVersion\nDatabase: $currentWaspDbSize\n\n"
fi

if [ -f "/usr/bin/iota-inx-indexer" ]; then
    iotaInxIndexerAppInfo="INX-Indexer\nStatus: $iotaInxIndexerStatus\nVersion: $iotaInxIndexerVersion\nDatabase: $currentIotaInxIndexerDbSize\n\n"
fi

if [ -f "/usr/bin/iota-inx-mqtt" ]; then
    iotaInxMqttAppInfo="INX-MQTT\nStatus: $iotaInxMqttStatus\nVersion: $iotaInxMqttVersion\n\n"
fi

if [ -f "/usr/bin/iota-inx-participation" ]; then
    iotaInxarticipationAppInfo="INX-Participation\nStatus: $iotaInxParticipationStatus\nVersion: $iotaInxParticipationVersion\nDatabase: $currentIotaInxParticipationDbSize\n\n"
fi

if [ -f "/usr/bin/shimmer-inx-indexer" ]; then
    shimmerInxIndexerAppInfo="INX-Indexer\nStatus: $shimmerInxIndexerStatus\nVersion: $shimmerInxIndexerVersion\nDatabase: $currentShimmerInxIndexerDbSize\n\n"
fi

if [ -f "/usr/bin/shimmer-inx-mqtt" ]; then
    shimmerInxMqttAppInfo="INX-MQTT\nStatus: $shimmerInxMqttStatus\nVersion: $shimmerInxMqttVersion\n\n"
fi

if [ -f "/usr/bin/shimmer-inx-participation" ]; then
    shimmerInxParticipationAppInfo="INX-Participation\nStatus: $shimmerInxParticipationStatus\nVersion: $shimmerInxParticipationVersion\nDatabase: $currentShimmerInxParticipationDbSize\n\n"
fi

# OUTPUT
whiptail --scrolltext --title "SWARM - App Info" --msgbox "\n${hornetAppInfo}${shimmerHornetAppInfo}${beeAppInfo}${shimmerBeeAppInfo}${goshimmerAppInfo}${waspAppInfo}${shimmerInxIndexerAppInfo}${shimmerInxMqttAppInfo}${shimmerInxParticipationAppInfo}" 24 65
