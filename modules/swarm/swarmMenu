#!/bin/bash
while [ $exitCode -lt 1 ]; do
    clear
    CHOICE=$(
        whiptail --title "SWARM Menu" --menu "\nChoose an option" 22 65 0 \
        "1)" "Swarm Auth" \
        "2)" "Node(s) Info" \
        "3)" "SWARM Info" \
        "4)" "SWARM Configuration" \
        "5)" "Watchdog Configuration" \
        "6)" "SWARM Tools" \
        "7)" "Manage SWARM" 3>&2 2>&1 1>&3
    )
    exitstatus=$?
    if [ "$exitstatus" = "1" ]; then
        exitCode=1
    fi
    case $CHOICE in
        "1)")
            while [ $exitCode -lt 1 ]; do
                source $swarmConfigs/swarm.cfg
                source $swarmModules/swarmAuth
                CHOICE=$(
                    whiptail --title "SWARM - Auth" --menu "\nAuth Status: $swarmAuthText\n\nChoose an option" 18 65 0 \
                    "1)" "Set Password" \
                    "2)" "Set Username" 3>&2 2>&1 1>&3
                )
                exitStatus=$?
                if [ "$exitStatus" = "1" ]; then
                    exitCode=1
                fi
                case $CHOICE in
                    "1)")
                        inputSwarmAuthPwd=$(whiptail --passwordbox "\nPlease enter the password for the update access of SWARM:" 8 65 --title "SWARM - Auth" 3>&1 1>&2 2>&3)
                        exitStatus=$?
                        if [ $exitStatus = 0 ] && [ "$swarmAuthPwd" != "$inputSwarmAuthPwd" ]; then
                            swarmAuthPwd="$inputSwarmAuthPwd"
                            sudo sed -i 's~^swarmAuthPwd=.*~swarmAuthPwd="'$swarmAuthPwd'"~g' $swarmConfigs/swarm.cfg
                            unset swarmAuth
                        fi
                        unset inputSwarmAuthPwd
                    ;;
                    "2)")
                        inputSwarmAuthUser=$(whiptail --inputbox "Type the username for the update access of SWARM:" 10 65 $swarmAuthUser --title "SWARM - Auth" 3>&1 1>&2 2>&3)
                        exitStatus=$?
                        if [ $exitStatus = 0 ] && [ "$swarmAuthUser" != "$inputSwarmAuthUser" ]; then
                            swarmUpdateAuthUser="$inputSwarmAuthUser"
                            sudo sed -i 's~^swarmAuthUser=.*~swarmAuthUser="'$swarmAuthUser'"~g' $swarmConfigs/swarm.cfg
                            unset swarmAuth
                        fi
                        unset inputSwarmAuthUser
                    ;;
                esac
            done
            exitCode=0
        ;;
        "2)")
            source $swarmModules/swarmNodeInfo
        ;;
        "3)")
            swarmInfo=true
            source $swarmModules/swarmInfo
            unset swarmInfo
        ;;
        "4)")
            source $swarmModules/swarmConfiguration
        ;;
        "5)")
            source $swarmModules/swarmWatchdogConfiguration
        ;;
        "6)")
            source $swarmModules/swarmTools
        ;;
        "7)")
            CHOICE=$(
                whiptail --title "SWARM Menu" --menu "\nChoose an option" 20 65 0 \
                "1)" "Update SWARM" \
                "2)" "Remove SWARM" \
                "3)" "Check SWARM.log" 3>&2 2>&1 1>&3
            )
            case $CHOICE in
                "1)")
                    # Update SWARM
                    if (whiptail --title "SWARM - Update" --yesno --defaultno "Do you really want to update SWARM?" 8 65); then
                        inputLatestSwarmVersion=$(whiptail --inputbox "Type the username for the update access of SWARM:" 10 65 "latest" --title "SWARM - Update" 3>&1 1>&2 2>&3)
                        exitstatus=$?
                        if [ "$exitstatus" != "1" ]; then
                            if [ "$inputLatestSwarmVersion" != "latest" ]; then
                                latestSwarmVersion="$inputLatestSwarmVersion"
                            fi
                            swarmManualUpdate=true
                            source $swarmModules/swarmUpdater
                            unset swarmManualUpdate inputLatestSwarmVersion
                            exit 0
                        fi
                    fi
                ;;
                "2)")
                    source $swarmModules/swarmRemoval
                ;;
                "3)")
                    sudo $swarmCLEditor $swarmLogs/swarm.log
                ;;
            esac
        ;;
    esac
done
exitCode=0
