#!/bin/bash

source $swarmConfigs/iota-hornet.cfg
iotaHornetApiRoutes=$(whiptail --title "INX-POI [IOTA] API routes" --checklist "\nSelect (spacebar) the routes you want to make public." 24 65 2 \
    "/api/poi/v1/create/*" "" OFF \
    "/api/poi/v1/validate" "" OFF 3>&1 1>&2 2>&3)
exitStatus=$?
iotaHornetApiRoutes=$(echo $iotaHornetApiRoutes | tr '[:upper:]' '[:lower:]' | tr -s '[:blank:]' ',' | tr -d '"')
if [ "$exitStatus" != "1" ] && [ ! -z "$iotaHornetApiRoutes" ]; then
    #/api/poi/v1/create/*
    if [[ $iotaHornetApiRoutes = */api/poi/v1/create/\** ]] && [[ $iotaHornetApiPublicRoutes != */api/poi/v1/create/\** ]]; then
        if [ -f "/usr/bin/iota-inx-poi" ]; then
            iotaHornetApiPublicRoutes=$(echo "$iotaHornetApiPublicRoutes,/api/poi/v1/create/*")
        fi
    fi

    #/api/poi/v1/validate
    if [[ $iotaHornetApiRoutes = */api/poi/v1/validate* ]] && [[ $iotaHornetApiPublicRoutes != */api/poi/v1/validate* ]]; then
        if [ -f "/usr/bin/iota-inx-poi" ]; then
            iotaHornetApiPublicRoutes=$(echo "$iotaHornetApiPublicRoutes,/api/poi/v1/validate")
        fi
    fi

    iotaHornetApiPublicRoutes=$(echo "$iotaHornetApiPublicRoutes" | tr -s ',,' ',')
    validateIotaHornetApiPublicRoutes=$(echo "${iotaHornetApiPublicRoutes: -1}")
    if [ "$validateIotaHornetApiPublicRoutes" = "," ]; then
        iotaHornetApiPublicRoutes="${iotaHornetApiPublicRoutes%?}"
    fi
    sudo sed -i 's~^iotaHornetApiPublicRoutes=.*~iotaHornetApiPublicRoutes="'$iotaHornetApiPublicRoutes'"~' $swarmConfigs/iota-hornet.cfg
    if (whiptail --title "INX-POI [IOTA] Installer" --yesno --defaultno "Do you want to restart Hornet to apply the new public API routes?" 8 65); then
        for iotaInxPlugin in ${iotaInxPlugins[@]}
        do
            if [ -f "/usr/bin/iota-inx-$iotaInxPlugin" ]; then
                sudo systemctl stop iota-inx-$iotaInxPlugin 2>/dev/null
            fi
        done
        unset iotaInxPlugin
        sudo systemctl restart iota-hornet 2>/dev/null
        for iotaInxPlugin in ${iotaInxPlugins[@]}
        do
            if [ -f "/usr/bin/iota-inx-$iotaInxPlugin" ]; then
                sudo systemctl start iota-inx-$iotaInxPlugin 2>/dev/null
            fi
        done
        unset iotaInxPlugin
    fi
fi
unset iotaHornetApiRoutes