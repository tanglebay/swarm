#!/bin/bash

source $swarmConfigs/bee-shimmer.cfg
source $swarmConfigs/proxy.cfg
source $proxyModules/proxyParser

sudo systemctl stop bee-shimmer > /dev/null 2>&1

sudo systemctl disable bee-shimmer > /dev/null 2>&1

sudo rm -rf /usr/bin/bee-shimmer /var/lib/bee-shimmer /lib/systemd/system/bee-shimmer.service /etc/default/bee-shimmer > /dev/null 2>&1

sudo systemctl daemon-reload > /dev/null 2>&1

if [ "$ufw" = "true" ]; then
    sudo ufw delete allow $beeShimmerGossipPort/tcp > /dev/null 2>&1
    sudo ufw delete allow $beeShimmerAutopeeringPort/udp > /dev/null 2>&1
fi

sudo rm -rf $beeShimmerHome > /dev/null 2>&1


if id bee > /dev/null 2>&1; then
    if [ ! -f "/usr/bin/bee" ]; then
        sudo deluser bee > /dev/null 2>&1
    fi
fi

if [ -f "/etc/nginx/sites-enabled/bee-shimmer" ]; then
    if [ "$ufw" = "true" ]; then
        if [ "$proxyBeeShimmerPort" != "$proxySwarmDashboardPort" ] && [ "$proxyBeeShimmerPort" != "$proxyHornetPort" ] && [ "$proxyBeeShimmerPort" != "$proxyHornetShimmerPort" ] && [ "$proxyBeeShimmerPort" != "$proxyBeePort" ] && [ "$proxyBeeShimmerPort" != "$proxyGoshimmerPort" ] && [ "$proxyBeeShimmerPort" != "$proxyWaspDashboardPort" ] && [ "$proxyBeeShimmerPort" != "$proxyWaspApiPort" ]; then
            sudo ufw delete allow $proxyBeeShimmerPort/tcp > /dev/null 2>&1
        fi
    fi
    sudo sed -i 's/^proxyBeeShimmerUrl=.*/proxyBeeShimmerUrl=/' $swarmConfigs/proxy.cfg
    sudo rm -rf /etc/nginx/sites-enabled/bee-shimmer > /dev/null 2>&1
    sudo systemctl reload nginx
fi

if [ -f "$proxyLandingPage" ]; then
    sudo sed -i 's/https:\/\/'$proxyBeeShimmerDashboardDomain':'$proxyBeeShimmerDashboardPort'\/dashboard" target="_blank/#/g' $proxyLandingPage
    sudo sed -i 's~/img/bee-shimmer.*id~/img/bee-shimmer_logo_gray.svg" alt="Bee-Shimmer not installed" id~' $proxyLandingPage
fi