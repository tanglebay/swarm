#!/bin/bash

if [ "$watchdogMemoryCheck" = "true" ]; then
    watchdogMemoryTotal=$(free -m | grep Mem: | awk '{ print $2 }')
    watchdogMemoryUsed=$(free -m | grep Mem: | awk '{ print $3 }')
    let watchdogMemoryFree=$watchdogMemoryTotal-$watchdogMemoryUsed
    if [ $watchdogMemoryFree -le $watchdogMemoryLimit ]; then
        for swarmApp in ${swarmApps[@]}
        do
            if [ -f "/usr/bin/$swarmApp" ]; then
                source $swarmModule/swarmAppVars
                if [ ! -f "/tmp/watchdog_$swarmApp.lock" ] && [ ! -f "/tmp/$swarmApp.lock" ]; then
                    if [ ! -f "/tmp/watchdog_$swarmApp.lock" ]; then
                        sudo touch /tmp/watchdog_$swarmApp.lock > /dev/null 2>&1
                    fi
                    restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                    if [ "$swarmApp" = "iota-hornet" ]; then
                        for iotaInxPlugin in ${iotaInxPlugins[@]}
                        do
                            if [ -f "/usr/bin/iota-inx-$iotaInxPlugin" ]; then
                                if [ ! -f "/tmp/watchdog_iota-inx-$iotaInxPlugin.lock" ]; then
                                    sudo touch /tmp/watchdog_iota-inx-$iotaInxPlugin.lock > /dev/null 2>&1
                                fi
                                sudo systemctl stop iota-inx-$iotaInxPlugin 2>/dev/null
                            fi
                        done
                        unset iotaInxPlugin
                    fi
                    if [ "$swarmApp" = "shimmer-hornet" ]; then
                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                        do
                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                if [ ! -f "/tmp/watchdog_shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                    sudo touch /tmp/watchdog_shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                fi
                                sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                            fi
                        done
                        unset shimmerInxPlugin
                    fi
                    sudo systemctl restart $swarmApp > /dev/null 2>&1
                    sleep 10
                    if [ "$swarmApp" = "iota-hornet" ]; then
                        for iotaInxPlugin in ${iotaInxPlugins[@]}
                        do
                            if [ -f "/usr/bin/iota-inx-$iotaInxPlugin" ]; then
                                sudo systemctl start iota-inx-$iotaInxPlugin 2>/dev/null
                                if [ -f "/tmp/watchdog_iota-inx-$iotaInxPlugin.lock" ]; then
                                    sudo rm -rf /tmp/watchdog_iota-inx-$iotaInxPlugin.lock > /dev/null 2>&1
                                fi
                            fi
                        done
                        unset iotaInxPlugin
                    fi
                    if [ "$swarmApp" = "shimmer-hornet" ]; then
                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                        do
                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                if [ -f "/tmp/watchdog_shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                    sudo rm -rf /tmp/watchdog_shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                fi
                            fi
                        done
                        unset shimmerInxPlugin
                    fi
                    swarmAppChecksum=${swarmAppPrefix}Checksum
                    echo "$restartDate [WATCHDOG] Memory limit reached and all services restarted." >> $swarmLogs/swarm.log
                    telegramText="Host: $HOSTNAME%0A%0AApp: Watchdog%0AAction: Memory limit reached and all installed services restarted."
                    source $watchdogModule/watchdogTelegram
                    if [ -f "/tmp/watchdog_$swarmApp.lock" ]; then
                        sudo rm -rf /tmp/watchdog_$swarmApp.lock > /dev/null 2>&1
                    fi
                fi
                unset swarmAppName swarmAppPrefix restartDate swarmAppRestart telegramText
            fi
        done
        unset swarmApp
    fi
    unset watchdogMemoryTotal watchdogMemoryUsed watchdogMemoryFree
fi