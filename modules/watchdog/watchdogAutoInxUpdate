#!/bin/bash
source $swarmConfigs/latest-versions.cfg

if [ "$timeFrame" = "$watchdogUpdateNumber" ] || [ "$timeFrame" = "$watchdogUpdateNumber2" ]; then
    if [ "$shimmerInxDashboardAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-dashboard" ]; then
        source $shimmerInxDashboardModules/shimmerInxDashboardVersion
        currentShimmerInxDashboardVersion="$shimmerInxDashboardVersion"
        if [ "$latestShimmerInxDashboardVersion" != "$shimmerInxDashboardVersion" ]; then
            source $shimmerInxDashboardModules/shimmerInxDashboardInstaller
            source $shimmerInxDashboardModules/shimmerInxDashboardVersion
            if [ "$currentShimmerInxDashboardVersion" != "$shimmerInxDashboardVersion" ] || [ "$shimmerInxDashboardUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxDashboardModules/shimmerInxDashboardParser
                if [ "$restartShimmerInxDashboard" = "true" ]; then
                    sudo systemctl restart shimmer-inx-dashboard > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxDashboardVersion) of INX-Dashboard installed. Checksum: $shimmerInxDashboardChecksum" >> $swarmLogs/swarm.log
                telegramText="Host: $HOSTNAME]%0AApp: Inx-Dashboard (Shimmer)%0A%0AAction: New Version <b>$latestShimmerInxDashboardVersion</b> installed.%0A%0AChecksum: $shimmerInxDashboardChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxDashboardVersion shimmerInxDashboardUpdated shimmerInxDashboardChecksum
    fi

    if [ "$shimmerInxIndexerAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-indexer" ]; then
        source $shimmerInxIndexerModules/shimmerInxIndexerVersion
        currentShimmerInxIndexerVersion="$shimmerInxIndexerVersion"
        if [ "$latestShimmerInxIndexerVersion" != "$shimmerInxIndexerVersion" ]; then
            source $shimmerInxIndexerModules/shimmerInxIndexerInstaller
            source $shimmerInxIndexerModules/shimmerInxIndexerVersion
            if [ "$currentShimmerInxIndexerVersion" != "$shimmerInxIndexerVersion" ] || [ "$shimmerInxIndexerUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxIndexerModules/shimmerInxIndexerParser
                if [ "$restartShimmerInxIndexer" = "true" ]; then
                    sudo systemctl restart shimmer-inx-indexer > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxIndexerVersion) of INX-Indexer installed. Checksum: $shimmerInxIndexerChecksum" >> $swarmLogs/swarm.log
                telegramText="Host: $HOSTNAME]%0AApp: Inx-Indexer (Shimmer)%0A%0AAction: New Version <b>$latestShimmerInxIndexerVersion</b> installed.%0A%0AChecksum: $shimmerInxIndexerChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxIndexerVersion shimmerInxIndexerUpdated shimmerInxIndexerChecksum
    fi

    if [ "$shimmerInxMqttAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-mqtt" ]; then
        source $shimmerInxMqttModules/shimmerInxMqttVersion
        currentShimmerInxMqttVersion="$shimmerInxMqttVersion"
        if [ "$latestShimmerInxMqttVersion" != "$shimmerInxMqttVersion" ]; then
            source $shimmerInxMqttModules/shimmerInxMqttInstaller
            source $shimmerInxMqttModules/shimmerInxMqttVersion
            if [ "$currentShimmerInxMqttVersion" != "$shimmerInxMqttVersion" ] || [ "$shimmerInxMqttUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxMqttModules/shimmerInxMqttParser
                if [ "$restartShimmerInxMqtt" = "true" ]; then
                    sudo systemctl restart shimmer-inx-mqtt > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxMqttVersion) of [SHIMMER] INX-MQTT installed. Checksum: $shimmerInxMqttChecksum" >> $swarmLogs/swarm.log
                telegramText="Host: $HOSTNAME]%0AApp: Inx-MQTT (Shimmer)%0A%0AAction: New Version <b>$latestShimmerInxMqttVersion</b> installed.%0A%0AChecksum: $shimmerInxMqttChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxMqttVersion shimmerInxMqttUpdated shimmerInxMqttChecksum
    fi

    if [ "$shimmerInxParticipationAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-participation" ]; then
        source $shimmerInxParticipationModules/shimmerInxParticipationVersion
        currentShimmerInxParticipationVersion="$shimmerInxParticipationVersion"
        if [ "$latestShimmerInxParticipationVersion" != "$shimmerInxParticipationVersion" ]; then
            source $shimmerInxParticipationModules/shimmerInxParticipationInstaller
            source $shimmerInxParticipationModules/shimmerInxParticipationVersion
            if [ "$currentShimmerInxParticipationVersion" != "$shimmerInxParticipationVersion" ] || [ "$shimmerInxParticipationUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxParticipationModules/shimmerInxParticipationParser
                if [ "$restartShimmerInxParticipation" = "true" ]; then
                    sudo systemctl restart shimmer-inx-participation > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxParticipationVersion) of [SHIMMER] INX-Participation installed. Checksum: $shimmerInxParticipationChecksum" >> $swarmLogs/swarm.log
                telegramText="Host: $HOSTNAME]%0AApp: Inx-Participation (Shimmer)%0A%0AAction: New Version <b>$latestShimmerInxParticipationVersion</b> installed.%0A%0AChecksum: $shimmerInxParticipationChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxParticipationVersion shimmerInxParticipationUpdated shimmerInxParticipationChecksum
    fi

    if [ "$shimmerInxPoiAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-poi" ]; then
        source $shimmerInxPoiModules/shimmerInxPoiVersion
        currentShimmerInxPoiVersion="$shimmerInxPoiVersion"
        if [ "$latestShimmerInxPoiVersion" != "$shimmerInxPoiVersion" ]; then
            source $shimmerInxPoiModules/shimmerInxPoiInstaller
            source $shimmerInxPoiModules/shimmerInxPoiVersion
            if [ "$currentShimmerInxPoiVersion" != "$shimmerInxPoiVersion" ] || [ "$shimmerInxPoiUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxPoiModules/shimmerInxPoiParser
                if [ "$restartShimmerInxPoi" = "true" ]; then
                    sudo systemctl restart shimmer-inx-poi > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxPoiVersion) of [SHIMMER] INX-POI installed. Checksum: $shimmerInxPoiChecksum" >> $swarmLogs/swarm.log
                telegramText="Host: $HOSTNAME]%0AApp: Inx-POI (Shimmer)%0A%0AAction: New Version <b>$latestShimmerInxPoiVersion</b> installed.%0A%0AChecksum: $shimmerInxPoiChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxPoiVersion shimmerInxPoiUpdated shimmerInxPoiChecksum
    fi
fi
