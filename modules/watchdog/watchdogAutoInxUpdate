#!/bin/bash
source $swarmConfigs/latest-versions.cfg

if [ "$timeFrame" = "$watchdogUpdateNumber" ] || [ "$timeFrame" = "$watchdogUpdateNumber2" ]; then
    if [ "$shimmerInxIndexerAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-indexer" ]; then
        source $shimmerInxIndexerModules/inxIndexerVersion
        currentShimmerInxIndexerVersion="$shimmerInxIndexerVersion"
        if [ "$latestShimmerInxIndexerVersion" != "$shimmerInxIndexerVersion" ]; then
            source $shimmerInxIndexerModules/inxIndexerInstaller
            source $shimmerInxIndexerModules/inxIndexerVersion
            if [ "$currentShimmerInxIndexerVersion" != "$shimmerInxIndexerVersion" ] || [ "$shimmerInxIndexerUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxIndexerModules/inxIndexerParser
                if [ "$restartShimmerInxIndexer" = "true" ]; then
                    sudo systemctl restart shimmer-inx-indexer > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxIndexerVersion) of INX-Indexer installed. Checksum: $shimmerInxIndexerChecksum" >> $swarmLogs/swarm.log
                telegramText="[$HOSTNAME] New Version ($latestShimmerInxIndexerVersion) of [SHIMMER] INX-Indexer installed. Checksum: $shimmerInxIndexerChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxIndexerVersion shimmerInxIndexerUpdated shimmerInxIndexerChecksum
    fi

    if [ "$shimmerInxMqttAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-mqtt" ]; then
        source $shimmerInxMqttModules/inxMqttVersion
        currentShimmerInxMqttVersion="$shimmerInxMqttVersion"
        if [ "$latestShimmerInxMqttVersion" != "$shimmerInxMqttVersion" ]; then
            source $shimmerInxMqttModules/inxMqttInstaller
            source $shimmerInxMqttModules/inxMqttVersion
            if [ "$currentShimmerInxMqttVersion" != "$shimmerInxMqttVersion" ] || [ "$shimmerInxMqttUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxMqttModules/inxMqttParser
                if [ "$restartShimmerInxMqtt" = "true" ]; then
                    sudo systemctl restart shimmer-inx-mqtt > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxMqttVersion) of [SHIMMER] INX-MQTT installed. Checksum: $shimmerInxMqttChecksum" >> $swarmLogs/swarm.log
                telegramText="[$HOSTNAME] New Version ($latestShimmerInxMqttVersion) of [SHIMMER] INX-MQTT installed. Checksum: $shimmerInxMqttChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxMqttVersion shimmerInxMqttUpdated shimmerInxMqttChecksum
    fi

    if [ "$shimmerInxParticipationAutoUpdate" = "true" ] && [ -f "/usr/bin/shimmer-inx-participation" ]; then
        source $shimmerInxParticipationModules/inxParticipationVersion
        currentShimmerInxParticipationVersion="$shimmerInxParticipationVersion"
        if [ "$latestShimmerInxParticipationVersion" != "$shimmerInxParticipationVersion" ]; then
            source $shimmerInxParticipationModules/inxParticipationInstaller
            source $shimmerInxParticipationModules/inxParticipationVersion
            if [ "$currentShimmerInxParticipationVersion" != "$shimmerInxParticipationVersion" ] || [ "$shimmerInxParticipationUpdated" = "true" ]; then
                restartDate=`date '+%d-%m-%Y %H-%M-%S'`
                # CALL MODULE CONFIGPARSER
                source $shimmerInxParticipationModules/inxParticipationParser
                if [ "$restartShimmerInxParticipation" = "true" ]; then
                    sudo systemctl restart shimmer-inx-indexer > /dev/null 2>&1
                    sleep 5
                fi
                echo "$restartDate [AUTOUPDATE] New Version ($latestShimmerInxParticipationVersion) of [SHIMMER] INX-Participation installed. Checksum: $shimmerInxParticipationChecksum" >> $swarmLogs/swarm.log
                telegramText="[$HOSTNAME] New Version ($latestShimmerInxParticipationVersion) of [SHIMMER] INX-Participation installed. Checksum: $shimmerInxParticipationChecksum"
                source $watchdogModules/watchdogTelegram
            fi
        fi
        unset currentShimmerInxParticipationVersion shimmerInxParticipationUpdated shimmerInxParticipationChecksum
    fi
fi
