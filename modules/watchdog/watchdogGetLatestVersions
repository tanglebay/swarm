#!/bin/bash
source $swarmConfigs/latest-versions.cfg

# SET TIME
timeFrame=`date '+%M'`

# GET LATEST VERSIONS
if [ "$timeFrame" = "00" ] || [ "$timeFrame" = "15" ] || [ "$timeFrame" = "30" ] || [ "$timeFrame" = "45" ]; then
    # Latest SWARM version
    latestSwarmVersion=$(curl --max-time 5 -Ls https://cdn.tanglebay.com/swarm/version/stable | head -n 1)
    latestSwarmVersion=$(echo $latestSwarmVersion | tr -d 'v')
    sudo sed -i 's~^latestSwarmVersion=.*~latestSwarmVersion="'$latestSwarmVersion'"~' $swarmConfigs/latest-versions.cfg
fi

if [ "$timeFrame" = "$watchdogUpdateNumber" ] || [ "$timeFrame" = "$watchdogUpdateNumber2" ]; then
    for swarmApp in ${swarmApps[@]}
    do
        source $swarmModule/swarmAppVars
        if [ -f "/usr/bin/$swarmApp" ]; then
            swarmAppCurrentLatestVersion=latest${swarmAppPrefix^}Version
            swarmAppRelease=${swarmAppPrefix}Release
            swarmAppReleaseVersion=${swarmAppPrefix}ReleaseVersion
            swarmAppModule=${swarmAppPrefix}Module

            if [ ! -z "${!swarmAppReleaseVersion}" ]; then
                swarmGrepAppReleaseVersion="| grep ${!swarmAppReleaseVersion}"
            fi

            if [ "${!swarmAppRelease}" = "stable" ]; then
                swarmAppLatestVersion=$(curl --max-time 5 -Ls https://$swarmAuthUser:$swarmAuthPwd@cdn.tanglebay.com/github/releases/$swarmAppGithubName $swarmGrepAppReleaseVersion | awk '!/(-rc|-beta|-alpha)/' | head -n 1)
                swarmAppLatestVersion=$(echo $swarmAppLatestVersion | tr -d 'v')
            fi
            if [ "${!swarmAppRelease}" = "beta" ]; then
                swarmAppLatestVersion=$(curl --max-time 5 -Ls https://$swarmAuthUser:$swarmAuthPwd@cdn.tanglebay.com/github/releases/$swarmAppGithubName | grep ${!swarmAppReleaseVersion} | awk '!/-alpha/' | head -n 1)
                swarmAppLatestVersion=$(echo $swarmAppLatestVersion | tr -d 'v')
            fi
            if [ "${!swarmAppRelease}" = "alpha" ]; then
                swarmAppLatestVersion=$(curl --max-time 5 -Ls https://$swarmAuthUser:$swarmAuthPwd@cdn.tanglebay.com/github/releases/$swarmAppGithubName | grep ${!swarmAppReleaseVersion} | head -n 1)
                swarmAppLatestVersion=$(echo $swarmAppLatestVersion | tr -d 'v')
            fi
            if [ "$swarmAppLatestVersion" = "\"\"" ] || [ -z "$swarmAppLatestVersion" ] || [ "$swarmAppLatestVersion" = "null" ]; then
                if [ -f "/usr/bin/$swarmApp" ]; then
                    source ${!swarmAppModule}/${swarmAppPrefix}Version
                    swarmAppLatestVersion=${swarmAppPrefix}Version
                fi
            fi
            if [ "$(printf '%s\n' "$swarmAppLatestVersion" "${!swarmAppCurrentLatestVersion}" | sort -V | head -n1)" != "$swarmAppLatestVersion" ] && [ ! -z "$swarmAppLatestVersion" ]; then
                sudo sed -i 's~^latest'${swarmAppPrefix^}'Version=.*~latest'${swarmAppPrefix^}'Version="'$swarmAppLatestVersion'"~' $swarmConfigs/latest-versions.cfg
            fi
        else
            if [ ! -z "$swarmAppLatestVersion" ]; then
                sudo sed -i 's~^latest'${swarmAppPrefix^}'Version=.*~latest'${swarmAppPrefix^}'Version=""~' $swarmConfigs/latest-versions.cfg
            fi
        fi
        unset swarmAppGithubName swarmAppPrefix swarmAppCurrentLatestVersion swarmAppRelease swarmAppReleaseVersion swarmAppModule swarmAppLatestVersion swarmGrepAppReleaseVersion
    done
    unset swarmApp
fi