#!/bin/bash

# HORNET MENU
while [ $exitCode -lt 1 ]; do
    source $swarmConfigs/shimmer-hornet.cfg
    clear
    CHOICE=$(
        whiptail --title "Hornet [SHIMMER] Menu" --menu "\nChoose an option" 24 65 0 \
        "" "" \
        "1)" "Hornet Info" \
        "2)" "Hornet Configuration" \
        "3)" "Hornet Management" \
        "4)" "Hornet Installer" 3>&2 2>&1 1>&3
    )
    exitstatus=$?
    if [ "$exitstatus" = "1" ]; then
        exitCode=1
    fi

    case $CHOICE in
        "1)")
            source $shimmerHornetModule/shimmerHornetInfo
        ;;
        "2)")
            while [ $exitCode -lt 1 ]; do
                clear
                CHOICE=$(
                    whiptail --title "Hornet [SHIMMER] Configuration" --menu "\nChoose an option" 24 65 0 \
                    "" "" \
                    "1)" "Hornet Configuration" \
                    "2)" "Advanced Configuration" 3>&2 2>&1 1>&3
                )

                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        source $shimmerHornetModule/shimmerHornetConfiguration
                    ;;
                    "2)")
                        while [ $exitCode -lt 1 ]; do
                            clear
                            CHOICE=$(
                                whiptail --title "Hornet [SHIMMER] Configuration" --menu "\nChoose an option" 24 65 0 \
                                "" "" \
                                "1)" "Peering.json" \
                                "2)" "Config_Mainnet.json" \
                                "3)" "Shimmer-Hornet.cfg (SWARM)" 3>&2 2>&1 1>&3
                            )

                            exitstatus=$?
                            if [ "$exitstatus" = "1" ]; then
                                exitCode=1
                            fi

                            case $CHOICE in
                                "1)")
                                    sudo $swarmCLEditor $shimmerHornetHome/peering.json
                                    if (whiptail --title "Hornet [SHIMMER] Configuration" --yesno --defaultno "Would you like to restart [Shimmer] Hornet now?" 8 65); then
                                        if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                            sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                        fi
                                        {
                                            echo 0
                                            echo 10
                                            for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                            do
                                                if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                    if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                        sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                    fi
                                                    sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                fi
                                            done
                                            unset shimmerInxPlugin
                                            echo 33
                                            sudo systemctl restart shimmer-hornet > /dev/null 2>&1
                                            echo 66
                                            for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                            do
                                                if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                    sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                    if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                        sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                    fi
                                                fi
                                            done
                                            unset shimmerInxPlugin
                                            echo 100
                                            sleep 0.25
                                        } | whiptail --gauge "Please wait while [Shimmer] Hornet is restarting..." 8 65 0
                                        if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                            sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                        fi
                                    fi
                                ;;
                                "2)")
                                    sudo $swarmCLEditor $shimmerHornetHome/config_mainnet.json
                                    if [ -f "/usr/bin/shimmer-hornet" ]; then
                                        if (whiptail --title "Hornet [SHIMMER] Configuration" --yesno --defaultno "Would you like to restart [Shimmer] Hornet now?" 8 65); then
                                            if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                                sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                            fi
                                            {
                                                echo 0
                                                echo 10
                                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                                do
                                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                        if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                            sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                        fi
                                                        sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                    fi
                                                done
                                                unset shimmerInxPlugin
                                                echo 33
                                                sudo systemctl restart shimmer-hornet > /dev/null 2>&1
                                                echo 66
                                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                                do
                                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                        sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                        if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                            sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                        fi
                                                    fi
                                                done
                                                unset shimmerInxPlugin
                                                echo 100
                                                sleep 0.25
                                            } | whiptail --gauge "Please wait while [Shimmer] Hornet is restarting..." 8 65 0
                                            if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                                sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                            fi
                                        fi
                                    fi
                                ;;
                                "3)")
                                    sudo $swarmCLEditor $swarmConfigs/shimmer-hornet.cfg
                                    if [ -f "/usr/bin/shimmer-hornet" ]; then
                                        if (whiptail --title "Hornet [SHIMMER] Configuration" --yesno --defaultno "Would you like to restart [Shimmer] Hornet now?" 8 65); then
                                            if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                                sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                            fi
                                            {
                                                echo 0
                                                echo 25
                                                source $shimmerHornetModule/shimmerHornetParser
                                                echo 50
                                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                                do
                                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                        if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                            sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                        fi
                                                        sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                    fi
                                                done
                                                unset shimmerInxPlugin
                                                sudo systemctl restart shimmer-hornet > /dev/null 2>&1
                                                echo 75
                                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                                do
                                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                        sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                        if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                            sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                        fi
                                                    fi
                                                done
                                                unset shimmerInxPlugin
                                                echo 100
                                                sleep 0.25
                                            } | whiptail --gauge "Please wait while [Shimmer] Hornet is restarting..." 8 65 0
                                            if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                                sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                            fi
                                        fi
                                    fi
                                ;;
                            esac
                        done
                        exitCode=0
                    ;;
                esac
            done
            exitCode=0
        ;;
        "3)")
            if [ -f "/usr/bin/shimmer-hornet" ]; then
                while [ $exitCode -lt 1 ]; do
                    clear
                    CHOICE=$(
                        whiptail --title "Hornet [SHIMMER] Management" --menu "\nChoose your option" 24 65 0 \
                        "" "" \
                        "1)" "Hornet Log" \
                        "2)" "Start/Stop Hornet" \
                        "3)" "Reset Hornet All Databases" \
                        "4)" "Reset Hornet Config" 3>&2 2>&1 1>&3
                    )
                    exitstatus=$?
                    if [ "$exitstatus" = "1" ]; then
                        exitCode=1
                    fi
                    case $CHOICE in
                        "1)")
                            while [ $exitCode -lt 1 ]; do
                                clear
                                CHOICE=$(
                                    whiptail --title "Hornet [SHIMMER] Management" --menu "\nChoose your option" 24 65 0 \
                                    "" "" \
                                    "1)" "Show Live Log" \
                                    "2)" "Show Latest PANIC" 3>&2 2>&1 1>&3
                                )
                                exitstatus=$?
                                if [ "$exitstatus" = "1" ]; then
                                    exitCode=1
                                fi
                                case $CHOICE in
                                    "1)")
                                        sudo journalctl -fu shimmer-hornet
                                    ;;
                                    "2)")
                                        appLogDepth=10000
                                        appLogDepth=$(whiptail --inputbox "\nPlease enter a higher depth if no PANIC was found (this may take longer)" 10 65 $appLogDepth --title "Hornet [SHIMMER] Management" 3>&1 1>&2 2>&3)
                                        exitstatus=$?
                                        if [ "$exitstatus" != "1" ] && [ $appLogDepth -eq $appLogDepth ] 2>/dev/null; then
                                            echo ""
                                            echo "Please wait while the log is searched for a PANIC..."
                                            echo ""
                                            echo ""
<<<<<<< HEAD
                                            sudo journalctl -u shimmer-hornet -n $appLogDepth | grep -A 2 -B 2 -e PANIC | tail -n 5 > /tmp/swarm-app-panic.log
                                            appPanicLog=$(cat /tmp/swarm-app-panic.log)
                                            if [ ! -z "$appPanicLog" ]; then
                                                echo ""
                                                echo ""
                                                read -rsn1 -p "Press any key to exit."
                                            else
                                                clear
                                                whiptail --title "Hornet [SHIMMER] Management" --msgbox "No PANIC entry found or try again with a higher depth." 8 65
                                            fi
                                            if [ -f "/tmp/swarm-app-panic.log" ]; then
                                                sudo rm -rf /tmp/swarm-app-panic.log > /dev/null 2>&1
                                            fi
                                            unset appPanicLog
=======
                                            sudo journalctl -u iota-hornet -n $appLogDepth | grep -A 2 -B 2 -e PANIC | tail -n 5
                                            echo ""
                                            echo ""
                                            read -rsn1 -p "Press any key to exit."
>>>>>>> 392c4139d3d7913549588f2c0b411dc92a8591b4
                                        fi
                                        unset appLogDepth
                                    ;;
                                esac
                            done
                            exitCode=0
                        ;;
                        "2)")
                            while [ $exitCode -lt 1 ]; do
                                CHOICE=$(
                                    whiptail --title "Hornet [SHIMMER] Management" --menu "\nChoose your option" 24 65 0 \
                                    "" "" \
                                    "1)" "Restart Hornet" \
                                    "2)" "Start Hornet" \
                                    "3)" "Stop Hornet" \
                                    "4)" "Status Hornet" 3>&2 2>&1 1>&3
                                )
                                exitStatus=$?
                                if [ "$exitStatus" = "1" ]; then
                                    exitCode=1
                                fi
                                case $CHOICE in
                                    "1)")
                                        if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                            sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                        fi
                                        {
                                            echo 0
                                            echo 5
                                            for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                            do
                                                if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                    if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                        sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                    fi
                                                    sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                fi
                                            done
                                            unset shimmerInxPlugin
                                            echo 33
                                            sudo systemctl restart shimmer-hornet > /dev/null 2>&1
                                            echo 66
                                            for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                            do
                                                if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                    sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                    if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                        sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                    fi
                                                fi
                                            done
                                            unset shimmerInxPlugin
                                            echo 100
                                            sleep 0.25
                                        } | whiptail --gauge "Please wait while [Shimmer] Hornet is restarting..." 8 65 0
                                        if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                            sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                        fi
                                        whiptail --title "Hornet [SHIMMER] Management" --msgbox "[Shimmer] Hornet successfully restarted." 8 65
                                    ;;
                                    "2)")
                                        {
                                            echo 0
                                            echo 33
                                            sudo systemctl start shimmer-hornet > /dev/null 2>&1
                                            echo 66
                                            for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                            do
                                                if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                    sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                    if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                        sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                    fi
                                                fi
                                            done
                                            unset shimmerInxPlugin
                                            echo 100
                                            sleep 0.25
                                        } | whiptail --gauge "Please wait while [Shimmer] Hornet is starting..." 8 65 0
                                        if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                            sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                        fi
                                        whiptail --title "Hornet [SHIMMER] Management" --msgbox "[Shimmer] Hornet successfully started." 8 65
                                    ;;
                                    "3)")
                                        if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                            sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                        fi
                                        {
                                            echo 0
                                            for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                            do
                                                if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                    if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                        sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                    fi
                                                    sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                fi
                                            done
                                            unset shimmerInxPlugin
                                            echo 50
                                            sudo systemctl stop shimmer-hornet > /dev/null 2>&1
                                            echo 100
                                            sleep 0.25
                                        } | whiptail --gauge "Please wait while [Shimmer] Hornet is stopping..." 8 65 0
                                        whiptail --title "Hornet [SHIMMER] Management" --msgbox "[Shimmer] Hornet successfully stopped." 8 65
                                    ;;
                                    "4)")
                                        shimmerHornetStatus="$(sudo systemctl status shimmer-hornet)"
                                        whiptail --title "Hornet [SHIMMER] Management" --msgbox "$shimmerHornetStatus" 15 65
                                    ;;
                                esac
                            done
                            exitCode=0
                        ;;
                        "3)")
                            if (whiptail --title "Hornet [SHIMMER] Management" --yesno --defaultno "Are you sure you want to delete the [Shimmer] Hornet database?" 8 65); then
                                if (whiptail --title "Hornet [SHIMMER] Management" --yesno --defaultno "Do you want to use an alternative source for the [Shimmer] Hornet snapshot?" 8 65); then
                                    CHOICE=$(
                                        whiptail --title "Hornet [SHIMMER] Management" --menu "\nChoose your option" 24 65 0 \
                                        "" "" \
                                        "1)" "Download Snapshot For Governance [SGP 1,2,3,5]" \
                                        "2)" "Download Snapshot for genesis" \
                                        "3)" "Download Snapshot via URL" 3>&2 2>&1 1>&3
                                    )
                                    exitstatus=$?
                                    if [ "$exitstatus" != "1" ]; then
                                        case $CHOICE in
                                            "1)")
                                                shimmerHornetSnapshotSourceValid=$(curl --max-time 2 -s -o /dev/null -w "%{http_code}" https://$cdnUrl/snapshots/shimmer-mainnet/events/shimmer_governance_SGP_1-2-3-5.bin)
                                                if [ "$shimmerHornetSnapshotSourceValid" = "200" ]; then
                                                    shimmerHornetSnapshotSource="https://$cdnUrl/snapshots/shimmer-mainnet/events/shimmer_governance_SGP_1-2-3-5.bin"
                                                else
                                                    unset shimmerHornetSnapshotSourceValid
                                                    exitstatus=1
                                                fi
                                            ;;
                                            "2)")
                                                shimmerHornetSnapshotSourceValid=$(curl --max-time 2 -s -o /dev/null -w "%{http_code}" https://$cdnUrl/snapshots/shimmer-mainnet/events/genesis_snapshot.bin)
                                                if [ "$shimmerHornetSnapshotSourceValid" = "200" ]; then
                                                    shimmerHornetSnapshotSource="https://$cdnUrl/snapshots/shimmer-mainnet/events/genesis_snapshot.bin"
                                                else
                                                    unset shimmerHornetSnapshotSourceValid
                                                    exitstatus=1
                                                fi
                                            ;;
                                            "2)")
                                                shimmerHornetSnapshotSource=$(whiptail --inputbox "\nPlease specify the download url for the [Shimmer] Hornet full snapshot" 10 65 --title "Hornet [SHIMMER] Management" 3>&1 1>&2 2>&3)
                                                exitstatus=$?
                                                if [ "$exitStatus" != 1 ] && [[ $shimmerHornetSnapshotSource =~ *.bin$ ]]; then
                                                    shimmerHornetSnapshotSourceValid=$(curl --max-time 5 -s -o /dev/null -w "%{http_code}" $shimmerHornetSnapshotSource)
                                                    if [ "$shimmerHornetSnapshotSourceValid" != "200" ]; then
                                                        unset shimmerHornetSnapshotSource shimmerHornetSnapshotSourceValid
                                                        exitstatus=1
                                                    fi
                                                else
                                                    unset shimmerHornetSnapshotSource
                                                    exitstatus=1
                                                fi
                                            ;;
                                        esac
                                    fi
                                fi
                                if [ "$exitstatus" != "1" ]; then
                                    source $swarmConfigs/shimmer-hornet.cfg
                                    if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                        sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                    fi
                                    {
                                        echo 0
                                        echo 10
                                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                        do
                                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                    sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                fi
                                                sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                            fi
                                        done
                                        unset shimmerInxPlugin
                                        echo 20
                                        if [ "$killall" = "true" ]; then
                                            sudo killall -s SIGKILL shimmer-hornet > /dev/null 2>&1
                                        else
                                            sudo systemctl stop shimmer-hornet > /dev/null 2>&1
                                        fi
                                        echo 40
                                        sudo rm -rf $shimmerHornetHome/${shimmerHornetNetwork}/database $shimmerHornetHome/${shimmerHornetNetwork}/snapshots/*.bin > /dev/null 2>&1
                                        if [ ! -z "$shimmerHornetSnapshotSource" ]; then
                                            if [ ! -d "$shimmerHornetHome/${shimmerHornetNetwork}/snapshots" ]; then
                                                sudo -u hornet mkdir -p $shimmerHornetHome/${shimmerHornetNetwork}/snapshots > /dev/null 2>&1
                                            fi
                                            sudo -u hornet wget -q -O $shimmerHornetHome/${shimmerHornetNetwork}/snapshots/full_snapshot.bin $shimmerHornetSnapshotSource
                                        fi
                                        sudo sed -i 's/^shimmerHornetStatusCounter=.*/shimmerHornetStatusCounter=0/' $swarmConfigs/watchdog.cfg
                                        sudo sed -i 's/^shimmerHornetSyncCounter=.*/shimmerHornetSyncCounter=0/' $swarmConfigs/watchdog.cfg
                                        echo 60
                                        sudo systemctl start shimmer-hornet > /dev/null 2>&1
                                        echo 80
                                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                        do
                                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                    sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                fi
                                            fi
                                        done
                                        unset shimmerInxPlugin
                                        echo 100
                                        sleep 0.25
                                    } | whiptail --gauge "Please wait while the [Shimmer] Hornet cleanup is running (this may take a while)..." 8 65 0
                                    if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                        sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                    fi
                                    whiptail --title "Hornet [SHIMMER] Management" --msgbox "[Shimmer] Hornet ${shimmerHornetNetwork}DB successfully reset." 8 65
                                fi
                            fi
                        ;;
                        "4)")
                            if (whiptail --title "Hornet [SHIMMER] Management" --yesno --defaultno "Are you sure you want to reset the [Shimmer] Hornet config file?" 8 65); then
                                source $swarmConfigs/shimmer-hornet.cfg
                                source $shimmerHornetModule/shimmerHornetConfigs
                                if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                    sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                fi
                                {
                                    echo 0
                                    echo 20
                                    sudo systemctl stop shimmer-hornet > /dev/null 2>&1
                                    echo 40
                                    sudo -u hornet wget -q -O $shimmerHornetHome/$shimmerHornetConfig.json https://raw.githubusercontent.com/iotaledger/hornet/staging/config_defaults.json
                                    source $shimmerHornetModule/shimmerHornetParser
                                    echo 60
                                    for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                    do
                                        if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                            if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                            fi
                                            sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                        fi
                                    done
                                    unset shimmerInxPlugin
                                    sudo systemctl start shimmer-hornet > /dev/null 2>&1
                                    echo 80
                                    for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                    do
                                        if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                            sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                            if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                            fi
                                        fi
                                    done
                                    unset shimmerInxPlugin
                                    echo 100
                                    sleep 0.25
                                } | whiptail --gauge "Please wait while the [Shimmer] Hornet config reset is running (this may take a while)..." 8 65 0
                                if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                    sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                fi
                                whiptail --title "Hornet [SHIMMER] Management" --msgbox "[Shimmer] Hornet ${shimmerHornetNetwork} config successfully reset." 8 65
                            fi
                        ;;
                    esac
                done
                exitCode=0
            else
                whiptail --title "Hornet [SHIMMER] Management" --msgbox "[Shimmer] Hornet installation not found, please install [Shimmer] Hornet first." 8 65
            fi
        ;;
        "4)")
            while [ $exitCode -lt 1 ]; do
                CHOICE=$(
                    whiptail --title "Hornet [SHIMMER] Installer" --menu "\nChoose your option" 24 65 0 \
                    "" "" \
                    "1)" "Update Hornet" \
                    "2)" "Install Hornet" \
                    "3)" "Remove Hornet" 3>&2 2>&1 1>&3
                )

                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        if [ -f "/usr/bin/shimmer-hornet" ]; then
                            if (whiptail --title "Hornet [SHIMMER] Installer" --yesno --defaultno "Do you really want to update [Shimmer] Hornet?" 8 65); then
                                # Update HORNET
                                source $shimmerHornetModule/shimmerHornetVersion
                                if [ ! -z "$latestShimmerHornetVersion" ]; then
                                    if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                        sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                    fi
                                    {
                                        echo 0
                                        echo 33
                                        source $shimmerHornetModule/shimmerHornetVersion
                                        echo 66
                                        source $shimmerHornetModule/shimmerHornetInstaller                      
                                        echo 100
                                        sleep 0.5
                                    } | whiptail --gauge "Please wait while [Shimmer] Hornet is updated..." 8 65 0
                                    {
                                        # CALL MODULE CONFIGPARSER
                                        source $shimmerHornetModule/shimmerHornetParser
                                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                        do
                                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                if [ ! -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                    sudo touch /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                fi
                                                sudo systemctl stop shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                            fi
                                        done
                                        unset shimmerInxPlugin
                                        sudo systemctl restart shimmer-hornet 2>/dev/null
                                        sleep 5
                                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                        do
                                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                                                if [ -f "/tmp/shimmer-inx-$shimmerInxPlugin.lock" ]; then
                                                    sudo rm -rf /tmp/shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                                                fi
                                            fi
                                        done
                                        unset shimmerInxPlugin
                                    } | whiptail --gauge "Please wait while parsing the [Shimmer] Hornet configuration..." 8 65 0
                                    shimmerHornetChecksum=$(cat /tmp/shimmer-hornet.checksum 2>/dev/null)
                                    whiptail --title "Hornet [SHIMMER] Installer" --msgbox "[Shimmer] Hornet successfully updated.\n\nChecksum: $shimmerHornetChecksum" 10 65
                                    if [ -f "/tmp/shimmer-hornet.checksum" ]; then
                                        sudo rm -rf /tmp/shimmer-hornet.checksum > /dev/null 2>&1
                                        unset shimmerHornetChecksum
                                    fi
                                    if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                        sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                                    fi
                                else
                                    whiptail --title "Hornet [SHIMMER] Installer" --msgbox "Sorry, but [Shimmer] Hornet update aborted." 10 65
                                fi
                            fi
                        else
                            whiptail --title "Hornet [SHIMMER] Installer" --msgbox "Sorry, but [Shimmer] Hornet is not installed." 8 65
                        fi
                    ;;
                    "2)")
                        if [ -f "/usr/bin/iota-hornet" ] || [ -f "/usr/bin/goshimmer" ] || [ -f "/usr/bin/wasp" ]; then
                            if (whiptail --title "Hornet [SHIMMER] Installer" --yesno --defaultno "Already installed apps found on the system!\nIt is not recommended to run multiple apps on one host.\n\nDo you still want to continue?" 12 65); then
                                shimmerHornetSkipInstallation=false
                            else
                                shimmerHornetSkipInstallation=true
                            fi
                        else
                            shimmerHornetSkipInstallation=false
                        fi
                        # INSTALL Hornet
                        if [ ! -f "/usr/bin/shimmer-hornet" ] && [ "$shimmerHornetSkipInstallation" = "false" ]; then
                            if [ ! -f "/tmp/shimmer-hornet.lock" ]; then
                                sudo touch /tmp/shimmer-hornet.lock > /dev/null 2>&1
                            fi
                            source $swarmConfigs/shimmer-hornet.cfg
                            source $shimmerHornetModule/shimmerHornetConfigs
                            source $shimmerHornetModule/shimmerHornetVersion
                            {
                                echo 0
                                echo 10
                                echo 30
                                source $shimmerHornetModule/shimmerHornetInstaller
                                echo 50
                                if [ -f "/usr/bin/shimmer-hornet" ]; then
                                    source $swarmConfigs/shimmer-hornet.cfg
                                    echo 60
                                    # CALL MODULE CONFIGPARSER
                                    source $shimmerHornetModule/shimmerHornetParser
                                    echo 70
                                    if [ "$ufw" = "true" ]; then
                                        if [ "$shimmerHornetRunAsEntryNode" != "true" ]; then
                                            sudo ufw allow $shimmerHornetGossipPort/tcp > /dev/null 2>&1
                                        fi
                                        if [ "$shimmerHornetAutopeeringEnabled" = "true" ]; then
                                            sudo ufw allow $shimmerHornetAutopeeringPort/udp > /dev/null 2>&1
                                        fi
                                    fi
                                    sudo systemctl start shimmer-hornet > /dev/null 2>&1
                                    echo 80
                                    sleep 2
                                    shimmerHornetStatus="$(systemctl show -p ActiveState --value shimmer-hornet)"
                                    if [ "$shimmerHornetStatus" != "active" ]; then
                                        sudo systemctl restart shimmer-hornet > /dev/null 2>&1
                                    fi
                                    echo 100
                                fi
                            } | whiptail --gauge "Please wait while installing [Shimmer] Hornet..." 8 65 0
                            if [ -f "/usr/bin/shimmer-hornet" ]; then
                                if [ -f "/tmp/shimmer-hornet.checksum" ]; then
                                    shimmerHornetChecksum=$(cat /tmp/shimmer-hornet.checksum)
                                fi
                                whiptail --title "Hornet [SHIMMER] Installer" --msgbox "[Shimmer] Hornet installation finished!\n\nYou need to open the following ports for peering\n\nGossip: $shimmerHornetGossipPort/tcp\nAutopeering: $shimmerHornetAutopeeringPort/udp\n\nChecksum: $shimmerHornetChecksum" 17 65
                                if [ -f "/tmp/shimmer-hornet.checksum" ]; then
                                    sudo rm -rf /tmp/shimmer-hornet.checksum > /dev/null 2>&1
                                fi
                                if (whiptail --title "Proxy [SHIMMER] Hornet" --yesno --defaultno "Do you want to set up the proxy with the installation?" 8 65); then
                                    source $swarmConfigs/proxy.cfg
                                    if [ -z "$proxyShimmerHornetUrl" ]; then
                                        proxyUrl="example.com:443"
                                        proxyUrl=$(whiptail --inputbox "\nSet your domain and port for [Shimmer] Hornet" 10 65 $proxyUrl --title "Proxy [SHIMMER] Hornet" 3>&1 1>&2 2>&3)
                                        exitStatus=$?
                                        if [ "$proxyUrl" = "my.example.com:443" ]; then
                                            unset proxyUrl
                                        fi
                                        if [ "$exitStatus" != "1" ]; then
                                            source $proxyModule/proxyUrlValidation
                                            if [ "$proxyUrlValid" = "true" ]; then
                                                proxyShimmerHornetUrl=$proxyUrl
                                                sudo sed -i 's/^proxyShimmerHornetUrl=.*/proxyShimmerHornetUrl="'$proxyUrl'"/' $swarmConfigs/proxy.cfg
                                                source $proxyModule/proxyDeployment
                                            fi
                                        fi
                                        unset proxyUrl proxyUrlValid
                                    else
                                        proxyUrl=$proxyShimmerHornetUrl
                                        source $proxyModule/proxyUrlValidation
                                        if [ "$proxyUrlValid" = "true" ]; then
                                            source $proxyModule/proxyDeployment
                                        fi
                                        unset proxyUrl proxyUrlValid
                                    fi
                                fi
                            else
                                {
                                    echo 0
                                    echo 25
                                    source $swarmConfigs/shimmer-hornet.cfg
                                    echo 50
                                    source $shimmerHornetModule/shimmerHornetRemoval
                                    echo 75
                                    echo 100
                                } | whiptail --gauge "Please wait while the [Shimmer] Hornet files are removed..." 8 65 0
                                whiptail --title "Hornet [SHIMMER] Installer" --msgbox "Error while installing [Shimmer] Hornet! Please try again later." 8 65
                            fi
                            if [ -f "/tmp/shimmer-hornet.lock" ]; then
                                sudo rm -rf /tmp/shimmer-hornet.lock > /dev/null 2>&1
                            fi
                        else
                            if [ -f "/usr/bin/shimmer-hornet" ]; then
                                whiptail --title "Hornet [SHIMMER] Installer" --msgbox "[Shimmer] Hornet already installed." 8 65
                            else
                                if [ "$shimmerHornetSkipInstallation" = "true" ]; then
                                    whiptail --title "Hornet [SHIMMER] Installer" --msgbox "Installation of [Shimmer] Hornet aborted." 8 65
                                fi
                            fi
                        fi
                        unset shimmerHornetSkipInstallation shimmerHornetChecksum
                    ;;
                    "3)")
                        if (whiptail --title "Hornet [SHIMMER] Installer" --yesno --defaultno "Do you really want to remove [Shimmer] Hornet?" 8 65); then
                            {
                                echo 0
                                shimmerHornetRemoval=true
                                echo 50
                                source $shimmerHornetModule/shimmerHornetRemoval
                                echo 100
                                sleep 0.5
                            } | whiptail --gauge "Please wait while [Shimmer] Hornet will be removed..." 8 65 0
                            whiptail --title "Hornet [SHIMMER] Installer" --msgbox "[Shimmer] Hornet successfully removed." 8 65

                            if [ ! -f "/usr/bin/shimmer-hornet" ]; then
                                if (whiptail --title "Hornet [SHIMMER] Installer" --yesno --defaultno "Do you also want to remove all installed [Shimmer] INX plugins?" 8 65); then
                                    nmbCounter=0
                                    {
                                        echo $nmbCounter
                                        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                        do
                                            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                                source $shimmerInxModule/shimmer-inx-$shimmerInxPlugin/shimmerInx${shimmerInxPlugin}Removal
                                            fi
                                            let nmbCounter=$nmbCounter+10
                                            echo $nmbCounter
                                        done
                                    } | whiptail --gauge "Please wait while [Shimmer] INX plugins will be removed..." 8 65 0
                                    unset nmbCounter
                                    whiptail --title "Hornet [SHIMMER] Installer" --msgbox "[Shimmer] INX plugins successfully removed." 8 65
                                fi
                            fi
                        fi
                    ;;
                esac
            done
            exitCode=0
        ;;
    esac
done
exitCode=0
