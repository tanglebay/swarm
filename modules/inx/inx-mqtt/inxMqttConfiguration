#!/bin/bash
while [ $exitCode -lt 1 ]; do
    clear
    if [ "$inxMqttUpdateCheck" = "true" ]; then
        menuInxMqttUpdateCheck="Disable"
    else
        menuInxMqttUpdateCheck="Enable"
    fi
    source $inxMqttModules/inxMqttConfigs
    CHOICE=$(
        whiptail --title "INX-MQTT - Configurations" --menu "\nChoose an option" 24 65 0 \
        "1)" "MQTT Settings" \
        "2)" "INX Address" \
        "3)" "Enable Plugins" \
        "4)" "Disable Plugins" \
        "5)" "$menuInxMqttUpdateCheck update check" 3>&2 2>&1 1>&3
    )

    exitstatus=$?
    if [ "$exitstatus" = "1" ]; then
        exitCode=1
        if [ "$restartInxMqtt" = "true" ] && [ -f "/usr/bin/inx-mqtt" ]; then
            if (whiptail --title "INX-MQTT - Menu" --yesno "Would you like to apply the changes and restart INX-MQTT?" 8 65); then
                {
                    echo 0
                    echo 33
                    source $inxMqttModules/inxMqttParser
                    echo 50
                    sudo systemctl restart inx-mqtt > /dev/null 2>&1
                    sleep 0.25
                    echo 100
                    sleep 0.25
                } | whiptail --gauge "Please wait while the changes are applied and INX-MQTT is restarted..." 8 65 0
                unset restartInxMqtt
            fi
        fi
    fi

    case $CHOICE in
        "1)")
            while [ $exitCode -lt 1 ]; do
                clear
                CHOICE=$(
                    whiptail --title "INX-MQTT - MQTT Settings" --menu "\nChoose an option" 24 65 0 \
                    "1)" "Websocket Settings" \
                    "2)" "TCP Settings" 3>&2 2>&1 1>&3
                )
                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi
                case $CHOICE in
                    "1)")
                        while [ $exitCode -lt 1 ]; do
                            clear
                            if [ "$inxMqttWebsocketEnabled" = "true" ]; then
                                menuInxMqttWebsocketEnabled="Disable"
                            else
                                menuInxMqttWebsocketEnabled="Enable"
                            fi
                            CHOICE=$(
                                whiptail --title "INX-MQTT - Websocket" --menu "\nChoose an option" 24 65 0 \
                                "1)" "$menuInxMqttWebsocketEnabled websocket" \
                                "2)" "Websocket address" 3>&2 2>&1 1>&3
                            )
                            exitstatus=$?
                            if [ "$exitstatus" = "1" ]; then
                                exitCode=1
                            fi
                            case $CHOICE in
                                "1)")
                                    source $swarmConfigs/inx-mqtt.cfg
                                    if [ "$inxMqttWebsocketEnabled" = "true" ]; then
                                        inxMqttWebsocketEnabledStatus="enabled"
                                    else
                                        inxMqttWebsocketEnabledStatus="disabled"
                                    fi
                                    if (whiptail --title "INX-MQTT - Update Check" --yesno "Would you like to \"$inxMqttWebsocketEnabledStatus\" update check?" 8 65); then
                                        if [ "$inxMqttWebsocketEnabled" = "true" ]; then
                                            inxMqttWebsocketEnabled=false
                                        else
                                            inxMqttWebsocketEnabled=true
                                        fi
                                        source $inxMqttConfigParsers/inxMqttWebsocketEnabled
                                        sudo sed -i 's~^inxMqttWebsocketEnabled=.*~inxMqttWebsocketEnabled='$inxMqttWebsocketEnabled'~g' $swarmConfigs/inx-mqtt.cfg
                                    fi
                                ;;
                                "2)")
                                    source $swarmConfigs/inx-mqtt.cfg
                                    inxMqttWebsocketAddress=$(whiptail --inputbox "\nSet the address of the websocket interface" 10 65 $inxMqttWebsocketAddress --title "INX-MQTT - Websocket Address" 3>&1 1>&2 2>&3)
                                    exitStatus=$?
                                    if [ $exitStatus != 1 ]; then
                                        if [ ! -z "$inxMqttWebsocketAddress" ] && [[ $inxMqttWebsocketAddress =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:+[0-9]+|^localhost:[0-9]+$ ]]; then
                                            source $inxMqttConfigParsers/inxMqttWebsocketAddress
                                            if [ "$newInxMqttWebsocketAddress" = "true" ]; then
                                                sudo sed -i 's/^inxMqttWebsocketAddress=.*/inxMqttWebsocketAddress="'$inxMqttWebsocketAddress'"/' $swarmConfigs/inx-mqtt.cfg
                                                whiptail --title "INX-MQTT - Websocket Address" --msgbox "New websocket address \"$inxMqttWebsocketAddress\" applied!" 8 65
                                                unset newInxMqttWebsocketAddress
                                            else
                                                whiptail --title "INX-MQTT - Websocket Address" --msgbox "No websocket address change detected." 8 65
                                            fi
                                        else
                                            whiptail --title "INX-MQTT - Websocket Address" --msgbox "No valid websocket address, please try again." 8 65
                                        fi
                                    fi
                                ;;
                            esac
                        done
                        exitCode=0
                    ;;
                    "2)")
                        while [ $exitCode -lt 1 ]; do
                            clear
                            if [ "$inxMqttTcpEnabled" = "true" ]; then
                                menuInxMqttTcpEnabled="Disable"
                            else
                                menuInxMqttTcpEnabled="Enable"
                            fi
                            CHOICE=$(
                                whiptail --title "INX-MQTT - TCP" --menu "\nChoose an option" 24 65 0 \
                                "1)" "$menuInxMqttTcpEnabled TCP" \
                                "2)" "TCP address" 3>&2 2>&1 1>&3
                            )
                            exitstatus=$?
                            if [ "$exitstatus" = "1" ]; then
                                exitCode=1
                            fi
                            case $CHOICE in
                                "1)")
                                    source $swarmConfigs/inx-mqtt.cfg
                                    if [ "$inxMqttTcpEnabled" = "true" ]; then
                                        inxMqttTcpEnabledStatus="enabled"
                                    else
                                        inxMqttTcpEnabledStatus="disabled"
                                    fi
                                    if (whiptail --title "INX-MQTT - TCP" --yesno "Would you like to \"$inxMqttTcpEnabledStatus\" tcp interface?" 8 65); then
                                        if [ "$inxMqttTcpEnabled" = "true" ]; then
                                            inxMqttTcpEnabled=false
                                        else
                                            inxMqttTcpEnabled=true
                                        fi
                                        source $inxMqttConfigParsers/inxMqttTcpEnabled
                                        sudo sed -i 's~^inxMqttTcpEnabled=.*~inxMqttTcpEnabled='$inxMqttTcpEnabled'~g' $swarmConfigs/inx-mqtt.cfg
                                    fi
                                ;;
                                "2)")
                                    source $swarmConfigs/inx-mqtt.cfg
                                    inxMqttTcpAddress=$(whiptail --inputbox "\nSet the address of the TCP interface" 10 65 $inxMqttTcpAddress --title "INX-MQTT - TCP Address" 3>&1 1>&2 2>&3)
                                    exitStatus=$?
                                    if [ $exitStatus != 1 ]; then
                                        if [ ! -z "$inxMqttTcpAddress" ] && [[ $inxMqttTcpAddress =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:+[0-9]+|^localhost:[0-9]+$ ]]; then
                                            source $inxMqttConfigParsers/inxMqttTcpAddress
                                            if [ "$newInxMqttTcpAddress" = "true" ]; then
                                                sudo sed -i 's/^inxMqttTcpAddress=.*/inxMqttTcpAddress="'$inxMqttTcpAddress'"/' $swarmConfigs/inx-mqtt.cfg
                                                whiptail --title "INX-MQTT - TCP Address" --msgbox "New TCP address \"$inxMqttTcpAddress\" applied!" 8 65
                                                unset newInxMqttTcpAddress
                                            else
                                                whiptail --title "INX-MQTT - TCP Address" --msgbox "No TCP address change detected." 8 65
                                            fi
                                        else
                                            whiptail --title "INX-MQTT - TCP Address" --msgbox "No valid TCP address, please try again." 8 65
                                        fi
                                    fi
                                ;;
                            esac
                        done
                        exitCode=0
                    ;;
                esac
            done
            exitCode=0
        ;;
        "2)")
            source $swarmConfigs/inx-mqtt.cfg
            inxMqttInxAddress=$(whiptail --inputbox "\nSet the address of the INX interface" 10 65 $inxMqttInxAddress --title "INX-MQTT - INX Address" 3>&1 1>&2 2>&3)
            exitStatus=$?
            if [ $exitStatus != 1 ]; then
                if [ ! -z "$inxMqttInxAddress" ] && [[ $inxMqttInxAddress =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:+[0-9]+|^localhost:[0-9]+$ ]]; then
                    source $inxMqttConfigParsers/inxMqttInxAddress
                    if [ "$newInxMqttInxAddress" = "true" ]; then
                        sudo sed -i 's/^inxMqttInxAddress=.*/inxMqttInxAddress="'$inxMqttInxAddress'"/' $swarmConfigs/inx-mqtt.cfg
                        whiptail --title "INX-MQTT - INX Address" --msgbox "New INX address \"$inxMqttInxAddress\" applied!" 8 65
                        unset newInxMqttInxAddress
                    else
                        whiptail --title "INX-MQTT - INX Address" --msgbox "No INX address change detected." 8 65
                    fi
                else
                    whiptail --title "INX-MQTT - INX Address" --msgbox "No valid INX address, please try again." 8 65
                fi
            fi
        ;;
        "3)")
            useInxMqttEnablePlugins=true
            source $swarmConfigs/inx-mqtt.cfg
            currentInxMqttEnablePlugins=$inxMqttEnablePlugins
            source $inxMqttModules/inxMqttPlugins
            inxMqttEnablePlugins=$(whiptail --title "INX-MQTT - Plugins" --checklist "\nSelect (with spacebar) the INX-MQTT plugins to be activated:" 24 65 1 \
                "Prometheus" "plugin for metrics (e.g. Grafana)" $inxMqttPluginPrometheus 3>&1 1>&2 2>&3)
            exitStatus=$?
            inxMqttEnablePlugins=$(echo $inxMqttEnablePlugins | tr '[:upper:]' '[:lower:]' | tr -s '[:blank:]' ',' | tr -d '"')
            if [ -z "$inxMqttEnablePlugins" ] || [[ $inxMqttEnablePlugins = *prometheus* ]]; then
                if [ "$inxMqttEnablePlugins" != "$currentInxMqttEnablePlugins" ] && [ "$exitStatus" != "1" ]; then
                    if [ -f "/usr/bin/inx-mqtt" ]; then
                        source $inxMqttConfigParsers/inxMqttEnablePlugins
                    fi
                    sudo sed -i 's/^inxMqttEnablePlugins=.*/inxMqttEnablePlugins="'$inxMqttEnablePlugins'"/' $swarmConfigs/inx-mqtt.cfg
                    if [ ! -z "$inxMqttEnablePlugins" ]; then
                        whiptail --title "INX-MQTT - Plugins" --msgbox "The following plugins are enabled:\n$inxMqttEnablePlugins" 14 65
                    else
                        whiptail --title "INX-MQTT - Plugins" --msgbox "There are no plugins enabled for INX-MQTT!" 8 65
                    fi
                fi
                unset inxMqttEnablePlugins
            fi
            unset useInxMqttEnablePlugins
        ;;
        "4)")
            useInxMqttDisablePlugins=true
            source $swarmConfigs/inx-mqtt.cfg
            currentInxMqttDisablePlugins=$inxMqttDisablePlugins
            source $inxMqttModules/inxMqttPlugins
            inxMqttDisablePlugins=$(whiptail --title "INX-MQTT - Plugins" --checklist "\nSelect (with spacebar) the INX-MQTT plugins to be deactivated:" 24 65 1 \
                "Prometheus" "plugin for metrics (e.g. Grafana)" $inxMqttPluginPrometheus 3>&1 1>&2 2>&3)
            exitStatus=$?
            inxMqttDisablePlugins=$(echo $inxMqttDisablePlugins | tr '[:upper:]' '[:lower:]' | tr -s '[:blank:]' ',' | tr -d '"')
            if [ -z "$inxMqttDisablePlugins" ] || [[ $inxMqttDisablePlugins = *warpsync* ]]; then
                if [ "$inxMqttDisablePlugins" != "$currentInxMqttDisablePlugins" ] && [ "$exitStatus" != "1" ]; then
                    if [ -f "/usr/bin/inx-mqtt" ]; then
                        source $inxMqttConfigParsers/inxMqttDisablePlugins
                    fi
                    sudo sed -i 's/^inxMqttDisablePlugins=.*/inxMqttDisablePlugins="'$inxMqttDisablePlugins'"/' $swarmConfigs/inx-mqtt.cfg
                    if [ ! -z "$inxMqttDisablePlugins" ]; then
                        whiptail --title "INX-MQTT - Plugins" --msgbox "The following plugins are disabled:\n$inxMqttDisablePlugins" 14 65
                    else
                        whiptail --title "INX-MQTT - Plugins" --msgbox "There are no plugins disabled for INX-MQTT!" 8 65
                    fi
                fi
            else
                unset inxMqttDisablePlugins
            fi
            unset useInxMqttDisablePlugins
        ;;
        "5)")
            source $swarmConfigs/inx-mqtt.cfg
            if [ "$inxMqttUpdateCheck" = "true" ]; then
                inxMqttUpdateCheckStatus="enabled"
            else
                inxMqttUpdateCheckStatus="disabled"
            fi
            if (whiptail --title "INX-MQTT - Update Check" --yesno "Would you like to \"$inxMqttUpdateCheckStatus\" update check?" 8 65); then
                if [ "$inxMqttUpdateCheck" = "true" ]; then
                    inxMqttUpdateCheck=false
                else
                    inxMqttUpdateCheck=true
                fi
                source $inxMqttConfigParsers/inxMqttUpdateCheck
                sudo sed -i 's~^inxMqttUpdateCheck=.*~inxMqttUpdateCheck='$inxMqttUpdateCheck'~g' $swarmConfigs/inx-mqtt.cfg
            fi
        ;;
    esac
done
sudo chown -R inx:inx $inxMqttHome/*.json
exitCode=0