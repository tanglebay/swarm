#!/bin/bash

while [ $exitCode -lt 1 ]; do
    clear
    CHOICE=$(
        whiptail --title "INX - MQTT" --menu "\nChoose an option" 16 65 0 \
        "1)" "INX-MQTT Info" \
        "2)" "INX-MQTT Configuration" \
        "3)" "INX-MQTT Management" \
        "4)" "INX-MQTT Installer" 3>&2 2>&1 1>&3
    )

    exitstatus=$?
    if [ "$exitstatus" = "1" ]; then
        exitCode=1
    fi

    case $CHOICE in
        "1)")
            source $inxMqttModules/inxMqttInfo
        ;;
        "2)")
            while [ $exitCode -lt 1 ]; do
                clear
                CHOICE=$(
                    whiptail --title "INX-MQTT - Configuration" --menu "\nChoose an option" 22 65 0 \
                    "1)" "config.json" \
                    "2)" "inx-indexer.cfg (SWARM)" 3>&2 2>&1 1>&3
                )

                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        sudo $swarmCLEditor $inxMqttHome/config.json
                        if (whiptail --title "INX-MQTT - Configuration" --yesno --defaultno "Would you like to restart INX-MQTT now?" 8 65); then
                            {
                                echo 0
                                echo 50
                                sudo systemctl restart inx-mqtt > /dev/null 2>&1
                                echo 100
                                sleep 0.25
                            } | whiptail --gauge "Please wait while INX-MQTT is restarting..." 8 65 0
                        fi
                    ;;
                    "2)")
                        sudo $swarmCLEditor $swarmConfigs/inx-mqtt.cfg
                        if (whiptail --title "INX-MQTT - Configuration" --yesno --defaultno "Would you like to restart INX-MQTT now?" 8 65); then
                            {
                                echo 0
                                source $inxIndexerModules/inxMqttParser
                                echo 50
                                sudo systemctl restart inx-mqtt > /dev/null 2>&1
                                echo 100
                                sleep 0.25
                            } | whiptail --gauge "Please wait while INX-MQTT is restarting..." 8 65 0
                        fi
                    ;;
                esac
            done
            exitCode=0
        ;;
        "3)")
            while [ $exitCode -lt 1 ]; do
                clear
                CHOICE=$(
                    whiptail --title "INX-MQTT - Management" --menu "\nChoose an option" 22 65 0 \
                    "1)" "Show INX-MQTT log" \
                    "2)" "Stop/Start INX-MQTT" \
                    "3)" "Reset INX-MQTT" \
                    "4)" "Reset INX-MQTT config" 3>&2 2>&1 1>&3
                )

                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        # Display last 65 lines of log
                        sudo journalctl -fu inx-mqtt | less -FRSXM
                        clear
                    ;;
                    "2)")
                        CHOICE=$(
                            whiptail --title "INX-MQTT - Management" --menu "\nChoose your option" 20 65 0 \
                            "1)" "Restart INX-MQTT" \
                            "2)" "Start INX-MQTT" \
                            "3)" "Stop INX-MQTT" \
                            "4)" "Status INX-MQTT" 3>&2 2>&1 1>&3
                        )
                        case $CHOICE in
                            "1)")
                                {
                                    echo 0
                                    echo 50
                                    sudo systemctl restart inx-mqtt > /dev/null 2>&1
                                    echo 100
                                    sleep 0.25
                                } | whiptail --gauge "Please wait while INX-MQTT is restarting..." 8 65 0
                                whiptail --title "INX-MQTT - Management" --msgbox "INX-MQTT successfully restarted" 8 65
                            ;;
                            "2)")
                                {
                                    echo 0
                                    echo 50
                                    sudo systemctl start inx-mqtt > /dev/null 2>&1
                                    echo 100
                                    sleep 0.25
                                } | whiptail --gauge "Please wait while INX-MQTT is starting..." 8 65 0
                                whiptail --title "INX-MQTT - Management" --msgbox "INX-MQTT successfully started" 8 65
                            ;;
                            "3)")
                                {
                                    echo 0
                                    echo 50
                                    sudo systemctl stop inx-mqtt > /dev/null 2>&1
                                    echo 100
                                    sleep 0.25
                                } | whiptail --gauge "Please wait while INX-MQTT is stopping..." 8 65 0
                                whiptail --title "INX-MQTT - Management" --msgbox "INX-MQTT successfully stopped." 8 65
                            ;;
                            "4)")
                                inxMqttStatus="$(sudo systemctl status inx-mqtt)"
                                whiptail --title "INX-MQTT - Management" --msgbox "$inxIndexerStatus" 15 65
                            ;;
                        esac
                    ;;
                    "3)")
                        if (whiptail --title "INX-MQTT - Management" --yesno --defaultno "Are you sure you want to reset the INX-MQTT database?" 8 65); then
                            source $swarmConfigs/inx-mqtt.cfg
                            {
                                echo 0
                                echo 25
                                sudo systemctl stop inx-mqtt > /dev/null 2>&1
                                echo 50
                                sudo rm -rf $inxMqttHome/database > /dev/null 2>&1
                                echo 75
                                sudo systemctl start inx-mqtt > /dev/null 2>&1
                                echo 100
                                sleep 0.25
                            } | whiptail --gauge "Please wait while the database reset is running (this may take a while)..." 8 65 0
                            whiptail --title "INX-MQTT - Debugging" --msgbox "INX-MQTT database successfully reset." 8 65
                        fi
                    ;;
                    "4)")
                        if (whiptail --title "INX-MQTT - Management" --yesno --defaultno "Are you sure you want to reset the INX-MQTT config file?" 8 65); then
                            source $swarmConfigs/inx-mqtt.cfg
                            {
                                echo 0
                                echo 20
                                sudo systemctl stop inx-mqtt > /dev/null 2>&1
                                echo 40
                                sudo -u inx wget -q -O $inxMqttHome/config.json https://raw.githubusercontent.com/iotaledger/inx-mqtt/develop/config_template.json
                                echo 60
                                source $inxMqttModules/inxMqttParser
                                echo 80
                                sudo systemctl start inx-mqtt > /dev/null 2>&1
                                echo 100
                                sleep 0.25
                            } | whiptail --gauge "Please wait while the config reset is running (this may take a while)..." 8 65 0
                            whiptail --title "INX-MQTT - Debugging" --msgbox "INX-MQTT config successfully reset." 8 65
                        fi
                    ;;
                esac
            done
            exitCode=0
        ;;
        "4)")
            while [ $exitCode -lt 1 ]; do
                CHOICE=$(
                    whiptail --title "INX-MQTT - Installer" --menu "\nChoose your option" 18 65 0 \
                    "1)" "Update INX-MQTT" \
                    "2)" "Install INX-MQTT" \
                    "3)" "Remove INX-MQTT" 3>&2 2>&1 1>&3
                )

                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        if [ -f "/usr/bin/inx-mqtt" ]; then
                            if (whiptail --title "INX-MQTT - Installer" --yesno --defaultno "Do you really want to update INX-MQTT?" 8 65); then
                                # Update INX-Mqtt
                                source $inxMqttModules/inxMqttVersion
                                if [ "$latestInxMqttVersion" != "$inxMqttVersion" ]; then
                                    {
                                        echo 0
                                        echo 33
                                        source $inxMqttModules/inxMqttVersion
                                        echo 66
                                        source $inxMqttModules/inxMqttInstaller                      
                                        echo 100
                                        sleep 0.5
                                    } | whiptail --gauge "Please wait while INX-MQTT is updated..." 8 65 0
                                    newInxMqttVersion=$(/usr/bin/inx-mqtt -v | awk '{ print $2 }')
                                    if [ "$inxMqttVersion" != "$newInxMqttVersion" ]; then
                                        {
                                            # CALL MODULE CONFIGPARSER
                                            source $inxMqttModules/inxMqttParser
                                            sudo systemctl restart inx-mqtt 2>/dev/null
                                        } | whiptail --gauge "Please wait while parsing the configuration..." 8 65 0
                                    fi
                                    whiptail --title "INX-MQTT - Installer" --msgbox "INX-MQTT successfully updated.\n\nChecksum: $inxMqttChecksum" 10 65
                                else
                                    whiptail --title "INX-MQTT - Installer" --msgbox "Congratulations, you have already installed the latest version of INX-MQTT." 8 65
                                fi
                                unset inxMqttChecksum
                            fi
                        else
                            whiptail --title "INX-MQTT - Installer" --msgbox "Sorry, but INX-MQTT is not installed." 8 65
                        fi
                    ;;
                    "2)")
                        # INSTALL INX-MQTT
                        if [ ! -f "/usr/bin/inx-mqtt" ]; then
                            {
                                echo 0
                                echo 10
                                source $swarmConfigs/inx-mqtt.cfg
                                echo 30
                                source $inxMqttModules/inxMqttVersion
                                echo 40
                                source $inxMqttModules/inxMqttInstaller
                                echo 50
                                if [ -f "/usr/bin/inx-mqtt" ]; then
                                    source $swarmConfigs/inx-mqtt.cfg
                                    echo 60
                                    # CALL MODULE CONFIGPARSER
                                    source $inxMqttModules/inxMqttParser
                                    echo 70
                                    sudo systemctl start inx-mqtt > /dev/null 2>&1
                                    echo 80
                                    sleep 2
                                    inxMqttStatus="$(systemctl show -p ActiveState --value inx-mqtt)"
                                    if [ "$inxMqttStatus" != "active" ]; then
                                        sudo systemctl restart inx-mqtt > /dev/null 2>&1
                                    fi
                                    echo 100
                                fi
                            } | whiptail --gauge "Please wait while installing INX-MQTT..." 8 65 0
                            if [ -f "/usr/bin/inx-mqtt" ]; then
                                whiptail --title "INX-MQTT - Installer" --msgbox "INX-MQTT installation finished!\n\nChecksum: $inxMqttChecksum" 17 65
                            else
                                {
                                    echo 0
                                    echo 25
                                    source $swarmConfigs/inx-mqtt.cfg
                                    echo 50
                                    source $inxMqttModules/inxMqttRemoval
                                    echo 75
                                    echo 100
                                } | whiptail --gauge "Please wait while the INX-MQTT files are removed...." 8 65 0
                                whiptail --title "INX-MQTT - Installer" --msgbox "Error while installing INX-MQTT! Please try again later." 8 65
                            fi
                        else
                            if [ -f "/usr/bin/inx-mqtt" ]; then
                                whiptail --title "INX-MQTT - Installer" --msgbox "INX-MQTT already installed." 8 65
                            else
                                if [ "$inxMqttSkipInstallation" = "true" ]; then
                                    whiptail --title "INX-MQTT - Installer" --msgbox "Installation of INX-MQTT aborted." 8 65
                                fi
                            fi
                        fi
                        unset inxMqttSkipInstallation inxMqttChecksum
                    ;;
                    "3)")
                        if (whiptail --title "INX-MQTT - Installer" --yesno --defaultno "Do you really want to remove INX-MQTT?" 8 65); then
                            {
                                echo 0
                                echo 50
                                source $inxMqttModules/inxMqttRemoval
                                echo 100
                                sleep 0.5
                            } | whiptail --gauge "Please wait while INX-MQTT will be removed..." 8 65 0
                            whiptail --title "INX-MQTT - Installer" --msgbox "INX-MQTT successfully removed." 8 65
                        fi
                    ;;
                esac
            done
            exitCode=0
        ;;
    esac
done
exitCode=0