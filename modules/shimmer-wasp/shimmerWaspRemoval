#!/bin/bash
source $swarmConfigs/shimmer-wasp.cfg
source $swarmConfigs/proxy.cfg
source $proxyModule/proxyParser

sudo systemctl stop shimmer-wasp > /dev/null 2>&1

sudo systemctl disable shimmer-wasp > /dev/null 2>&1

sudo rm -rf /usr/bin/shimmer-wasp /var/lib/shimmer-wasp /lib/systemd/system/shimmer-wasp.service /etc/default/shimmer-wasp > /dev/null 2>&1

sudo systemctl daemon-reload > /dev/null 2>&1

sudo rm -rf $shimmerWaspHome > /dev/null 2>&1

if [ ! -f "/usr/bin/iota-wasp" ]; then
    if id wasp >/dev/null 2>&1; then
        sudo deluser wasp >/dev/null
    fi
fi

if [ -x "$(command -v apache2-utils)" ] && [ ! -f "/usr/bin/goshimmer" ] && [ ! -f "/usr/bin/iota-wasp" ]; then
    sudo apt -qq purge apache-utils -y > /dev/null 2>&1
    sudo apt -qq autoremove -y > /dev/null 2>&1
fi

getInxInstallations=$(ls /usr/bin/ | grep -E 'dashboard|indexer|mqtt|participation|poi')
if [ -z "$getInxInstallations" ] && [ ! -f "/usr/bin/iota-hornet" ] && [ ! -f "/usr/bin/hornet-shimmer" ] && [ ! -f "/usr/bin/iota-wasp" ] && [ ! -f "/usr/bin/goshimmer" ]; then
    sudo snap remove go > /dev/null 2>&1
fi

if [ -f "/etc/nginx/sites-enabled/shimmer-wasp-dashboard" ] || [ -f "/etc/nginx/sites-enabled/shimmer-wasp-api" ]; then
    if [ "$ufw" = "true" ]; then
        sudo ufw delete allow $shimmerWaspGossipPort/tcp > /dev/null 2>&1
        if [ "$proxyShimmerWaspDashboardPort" != "$proxyIotaHornetPort" ] && [ "$proxyShimmerWaspDashboardPort" != "$proxyShimmerHornetPort" ] && [ "$proxyShimmerWaspDashboardPort" != "$proxyIotaWaspDashboardPort" ] && [ "$proxyWaspDashboardPort" != "$proxyGoshimmerPort" ]; then
            sudo ufw delete allow $proxyWaspDashboardPort/tcp > /dev/null 2>&1
        fi
        if [ "$proxyShimmerWaspApiPort" != "$proxyIotaHornetPort" ] && [ "$proxyShimmerWaspApiPort" != "$proxyHornetShimmerPort" ] && [ "$proxyShimmerWaspApiPort" != "$proxyIotaWaspApiPort" ] && [ "$proxyShimmerWaspApiPort" != "$proxyGoshimmerPort" ]; then
            sudo ufw delete allow $proxyShimmerWaspApiPort/tcp > /dev/null 2>&1
        fi
    fi
    sudo sed -i 's/^proxyShimmerWaspDashboardUrl=.*/proxyShimmerWaspDashboardUrl=""/' $swarmConfigs/proxy.cfg
    sudo sed -i 's/^proxyShimmerWaspApiUrl=.*/proxyShimmerWaspApiUrl=""/' $swarmConfigs/proxy.cfg
    sudo rm -rf /etc/nginx/sites-enabled/shimmer-wasp* > /dev/null 2>&1
    sudo rm -rf /etc/nginx/swarm/shimmer-wasp > /dev/null 2>&1
    sudo systemctl reload nginx
fi