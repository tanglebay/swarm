#!/bin/bash

if [ -f "/usr/bin/shimmer-wasp" ]; then

    source $swarmConfigs/shimmer-wasp.cfg

    shimmerWaspStatus=$(systemctl show -p ActiveState --value shimmer-wasp)

    shimmerWaspVersion=$(cd $shimmerWaspHome ; /usr/bin/shimmer-wasp -v | awk '{print $2}' | tr -d 'v')
    if [ -z "$shimmerWaspVersion" ]; then
        shimmerWaspVersion="N/A"
    fi

    # DB size
    if [ -d "$shimmerWaspHome/waspdb" ]; then
        getCurrentDbSize="$(du -sb $shimmerWaspHome/waspdb | cut -f1)"
        let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
        if [ $getCurrentDbSizeInMb -gt 999 ]; then
            let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
            currentDbSize="${getCurrentDbSizeInGb} GB"
        else
            currentDbSize="${getCurrentDbSizeInMb} MB"
        fi
    else
        currentDbSize="N/A"
    fi

    if [ "$shimmerWaspWebapiAuthEnabled" = "true" ]; then
        shimmerWaspWebapiAuthEnabledStatus="✓"
    else
        shimmerWaspWebapiAuthEnabledStatus="X"
    fi

    if [ -f "/etc/nginx/sites-enabled/shimmer-wasp-dashboard" ]; then
        shimmerWaspDashboardProxyStatus="✓"
    else
        shimmerWaspDashboardProxyStatus="X"
    fi

    if [ -f "/etc/nginx/sites-enabled/shimmer-wasp-api" ]; then
        shimmerWaspWebapiProxyStatus="✓"
    else
        shimmerWaspWebapiProxyStatus="X"
    fi

    waspPeeringId=$(cd /var/lib/shimmer-wasp ; /usr/bin/shimmer-wasp-cli peering info | head -n 1 | awk '{ print $2 }')

    # OUTPUT
    whiptail --title "WASP [SHIMMER] Info" --msgbox "WASP: $shimmerWaspStatus\nVersion: $shimmerWaspVersion\nDB size: $currentDbSize\n\nProxy Dashboard: $shimmerWaspDashboardProxyStatus\nProxy WebAPI: $shimmerWaspWebapiProxyStatus\nWebAPI-Auth: $shimmerWaspWebapiAuthEnabledStatus\n\nPeering Port: ${shimmerWaspPeeringPort}/tcp\nNanomsg Port: ${shimmerWaspNanomsgPort}/tcp\n\nEnabled Plugins: \"$shimmerWaspEnablePlugins\"\nDisabled Plugins: \"$shimmerWaspDisablePlugins\"\n\nPeering-ID: $shimmerWaspPeeringId\nNetwork-ID: $shimmerWaspNetworkId:$shimmerWaspPeeringPort\nNodeconn: \"$shimmerWaspNodeconnAddress\"" 24 68
else
    # OUTPUT
    whiptail --title "WASP [SHIMMER] Info" --msgbox "WASP not installed!" 8 65
fi
