#!/bin/bash

source $swarmConfigs/shimmer-hornet.cfg
nodeStatusCode=1
while [ $nodeStatusCode -gt 0 ]; do
    shimmerHornetStatus=$(curl curl --max-time 2 -s -X GET "http://localhost:14266/api/core/v2/info" -H  "accept: application/json" -H "Authorization: Bearer ${shimmerHornetApiJwtToken}"|jq -r '.status.isHealthy' 2> /dev/null)
    if [ "$shimmerHornetStatus" = "true" ] || [ "$shimmerHornetStatus" = "false" ]; then
        for shimmerInxPlugin in ${shimmerInxPlugins[@]}
        do
            if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                sudo systemctl start shimmer-inx-$shimmerInxPlugin 2>/dev/null
                if [ -f "/tmp/${watchdogInxLockTag}shimmer-inx-$shimmerInxPlugin.lock" ]; then
                    sudo rm -rf /tmp/${watchdogInxLockTag}shimmer-inx-$shimmerInxPlugin.lock > /dev/null 2>&1
                fi
            fi
        done
        nodeStatusCode=0
        unset shimmerInxPlugin watchdogInxLockTag
    else
        sleep 10
    fi
    unset shimmerHornetStatus
done
unset nodeStatusCode

exit 0