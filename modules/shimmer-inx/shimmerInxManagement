#!/bin/bash

# INX MANAGEMENT
while [ $exitCode -lt 1 ]; do
    clear
    CHOICE=$(
        whiptail --title "INX [SHIMMER] Management" --menu "\nChoose an option" 24 65 0 \
        "1)" "INX - Info" \
        "2)" "INX - Control" \
        "3)" "INX - Installer" 3>&2 2>&1 1>&3
    )
    exitstatus=$?
    if [ "$exitstatus" = "1" ]; then
        exitCode=1
    fi

    case $CHOICE in
        "1)")
            source $shimmerInxModules/shimmerInxInfo
        ;;
        "2)")
            # INX Control
            while [ $exitCode -lt 1 ]; do
                clear
                CHOICE=$(
                    whiptail --title "INX [SHIMMER] Management" --menu "\nChoose an option" 24 65 0 \
                    "1)" "Restart all INX plugins" \
                    "2)" "Start all INX plugins" \
                    "3)" "Stop all INX plugins" 3>&2 2>&1 1>&3
                )
                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        if (whiptail --title "INX [SHIMMER] Control" --yesno --defaultno "Do you really want to restart all INX plugins?" 8 65); then
                            {
                                whiptailGaugeNumber=10
                                echo 0
                                echo 10
                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                do
                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                        sudo systemctl restart shimmer-inx-$shimmerInxPlugin > /dev/null 2>&1
                                        let whiptailGaugeNumber=$whiptailGaugeNumber+10
                                        echo $whiptailGaugeNumber
                                    fi
                                done
                                echo 100
                                sleep 0.5
                                unset whiptailGaugeNumber
                            } | whiptail --gauge "Please wait while all INX plugins are restarted..." 8 65 0
                            whiptail --title "INX [SHIMMER] Control" --msgbox "Restart of all INX plugins completed." 8 65
                        fi
                    ;;
                    "2)")
                        if (whiptail --title "INX [SHIMMER] Control" --yesno --defaultno "Do you really want to start all INX plugins?" 8 65); then
                            {
                                whiptailGaugeNumber=10
                                echo 0
                                echo 10
                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                do
                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                        sudo systemctl start shimmer-inx-$shimmerInxPlugin > /dev/null 2>&1
                                        let whiptailGaugeNumber=$whiptailGaugeNumber+10
                                        echo $whiptailGaugeNumber
                                    fi
                                done
                                echo 100
                                sleep 0.5
                                unset whiptailGaugeNumber
                            } | whiptail --gauge "Please wait while all INX plugins are started..." 8 65 0
                            whiptail --title "INX [SHIMMER] Control" --msgbox "Start of all INX plugins completed." 8 65
                        fi
                    ;;
                    "3)")
                        if (whiptail --title "INX [SHIMMER] Control" --yesno --defaultno "Do you really want to stop all INX plugins?" 8 65); then
                            {
                                whiptailGaugeNumber=10
                                echo 0
                                echo 10
                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                do
                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                        sudo systemctl stop shimmer-inx-$shimmerInxPlugin > /dev/null 2>&1
                                        let whiptailGaugeNumber=$whiptailGaugeNumber+10
                                        echo $whiptailGaugeNumber
                                    fi
                                done
                                echo 100
                                sleep 0.5
                                unset whiptailGaugeNumber
                            } | whiptail --gauge "Please wait while all INX plugins are stopped..." 8 65 0
                            whiptail --title "INX [SHIMMER] Control" --msgbox "Termination of all INX plugins completed." 8 65
                        fi
                    ;;
                esac
            done
            exitCode=0
        ;;
        "3)")
            # INX Installer
            while [ $exitCode -lt 1 ]; do
                clear
                CHOICE=$(
                    whiptail --title "INX [SHIMMER] Management" --menu "\nChoose an option" 24 65 0 \
                    "1)" "Update all INX plugins" \
                    "2)" "Install all INX plugins" \
                    "3)" "Remove all INX plugins" 3>&2 2>&1 1>&3
                )
                exitstatus=$?
                if [ "$exitstatus" = "1" ]; then
                    exitCode=1
                fi

                case $CHOICE in
                    "1)")
                        if (whiptail --title "INX [SHIMMER] Installer" --yesno --defaultno "Do you really want to update all INX plugins?" 8 65); then
                            {
                                whiptailGaugeNumber=10
                                echo 0
                                echo 10
                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                do
                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                        if [ "$shimmerInxPlugin" = "dashboard" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxDashboardModules/shimmerInxDashboardVersion
                                            source $shimmerInxDashboardModules/shimmerInxDashboardInstaller
                                            source $shimmerInxDashboardModules/shimmerInxDashboardParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "indexer" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxIndexerModules/shimmerInxIndexerVersion
                                            source $shimmerInxIndexerModules/shimmerInxIndexerInstaller
                                            source $shimmerInxIndexerModules/shimmerInxIndexerParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "mqtt" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxMqttModules/shimmerInxMqttVersion
                                            source $shimmerInxMqttModules/shimmerInxMqttInstaller
                                            source $shimmerInxMqttModules/shimmerInxMqttParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "participation" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxParticipationModules/shimmerInxParticipationVersion
                                            source $shimmerInxParticipationModules/shimmerInxParticipationInstaller
                                            source $shimmerInxParticipationModules/shimmerInxParticipationParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "poi" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxPoiModules/shimmerInxPoiVersion
                                            source $shimmerInxPoiModules/shimmerInxPoiInstaller
                                            source $shimmerInxPoiModules/shimmerInxPoiParser
                                        fi
                                        sudo systemctl restart shimmer-inx-$shimmerInxPlugin > /dev/null 2>&1
                                        let whiptailGaugeNumber=$whiptailGaugeNumber+10
                                        echo $whiptailGaugeNumber
                                    fi
                                done
                                echo 100
                                sleep 0.5
                                unset whiptailGaugeNumber
                            } | whiptail --gauge "Please wait while all INX plugins are updated..." 8 65 0
                            whiptail --title "INX [SHIMMER] Installer" --msgbox "Update of all INX plugins completed." 8 65
                        fi
                    ;;
                    "2)")
                        if (whiptail --title "INX [SHIMMER] Installer" --yesno --defaultno "Do you really want to install all INX plugins?" 8 65); then
                            {
                                whiptailGaugeNumber=10
                                echo 0
                                echo 10
                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                do
                                    if [ ! -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                        if [ "$shimmerInxPlugin" = "dashboard" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxDashboardModules/shimmerInxDashboardVersion
                                            source $shimmerInxDashboardModules/shimmerInxDashboardInstaller
                                            source $shimmerInxDashboardModules/shimmerInxDashboardParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "indexer" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxIndexerModules/shimmerInxIndexerVersion
                                            source $shimmerInxIndexerModules/shimmerInxIndexerInstaller
                                            source $shimmerInxIndexerModules/shimmerInxIndexerParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "mqtt" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxMqttModules/shimmerInxMqttVersion
                                            source $shimmerInxMqttModules/shimmerInxMqttInstaller
                                            source $shimmerInxMqttModules/shimmerInxMqttParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "participation" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxParticipationModules/shimmerInxParticipationVersion
                                            source $shimmerInxParticipationModules/shimmerInxParticipationInstaller
                                            source $shimmerInxParticipationModules/shimmerInxParticipationParser
                                        fi
                                        if [ "$shimmerInxPlugin" = "poi" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxPoiModules/shimmerInxPoiVersion
                                            source $shimmerInxPoiModules/shimmerInxPoiInstaller
                                            source $shimmerInxPoiModules/shimmerInxPoiParser
                                        fi
                                        sudo systemctl start shimmer-inx-$shimmerInxPlugin > /dev/null 2>&1
                                        let whiptailGaugeNumber=$whiptailGaugeNumber+10
                                        echo $whiptailGaugeNumber
                                    fi
                                done
                                echo 100
                                sleep 0.5
                                unset whiptailGaugeNumber
                            } | whiptail --gauge "Please wait while all INX plugins are installed..." 8 65 0
                            whiptail --title "INX [SHIMMER] Installer" --msgbox "Installation of all INX plugins completed." 8 65
                        fi
                    ;;
                    "3)")
                        if (whiptail --title "INX [SHIMMER] Installer" --yesno --defaultno "Do you really want to remove all INX plugins?" 8 65); then
                            {
                                whiptailGaugeNumber=10
                                echo 0
                                echo 10
                                for shimmerInxPlugin in ${shimmerInxPlugins[@]}
                                do
                                    if [ -f "/usr/bin/shimmer-inx-$shimmerInxPlugin" ]; then
                                        if [ "$shimmerInxPlugin" = "dashboard" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxDashboardModules/shimmerInxDashboardRemoval
                                        fi
                                        if [ "$shimmerInxPlugin" = "indexer" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxIndexerModules/shimmerInxIndexerRemoval
                                        fi
                                        if [ "$shimmerInxPlugin" = "mqtt" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxMqttModules/shimmerInxMqttRemoval
                                        fi
                                        if [ "$shimmerInxPlugin" = "participation" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxParticipationModules/shimmerInxParticipationRemoval
                                        fi
                                        if [ "$shimmerInxPlugin" = "poi" ]; then
                                            source $swarmConfigs/shimmer-inx-$shimmerInxPlugin.cfg
                                            source $shimmerInxPoiModules/shimmerInxPoiRemoval
                                        fi
                                        let whiptailGaugeNumber=$whiptailGaugeNumber+10
                                        echo $whiptailGaugeNumber
                                    fi
                                done
                                echo 100
                                sleep 0.5
                                unset whiptailGaugeNumber
                            } | whiptail --gauge "Please wait while all INX plugins are removed..." 8 65 0
                            whiptail --title "INX [SHIMMER] Installer" --msgbox "Removal of all INX plugins completed." 8 65
                        fi
                    ;;
                esac
            done
            exitCode=0
        ;;
    esac
done
exitCode=0
