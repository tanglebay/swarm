#!/bin/bash

if [ "$proxyAutomaticDeployment" = "true" ] && [ -d "$proxyPath" ]; then
    source $proxyModulePath/proxyConfigCheck

    if [ "$TRAEFIK_PROTOCOL" = "https" ]; then
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml -f docker-traefik-https.yml down > /dev/null 2>&1 )
    else
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml down > /dev/null 2>&1 )
    fi

    cp -rf $swarmConfigsPath/docker-env.cfg $swarmDockerPath/.env > /dev/null 2>&1

    if [ "$TRAEFIK_PROTOCOL" = "https" ]; then
        if [ "$TRAEFIK_SSL_RESOLVER" = "acme" ]; then
            cp -rf $swarmTemplatesPath/docker/acme.yaml $proxyPath/dynamic/acme.yaml > /dev/null 2>&1
            sed -i 's~^email:.*~email: '$TRAEFIK_ACME_EMAIL'~g' $proxyPath/dynamic/acme.yaml
        fi
        if [ "$TRAEFIK_SSL_RESOLVER" = "custom" ]; then
            if [ ! -f "$proxyPath/dynamic/tls.yaml" ]; then
                cp -rf $swarmTemplatesPath/docker/tls_custom.yaml $proxyPath/dynamic/tls.yaml > /dev/null 2>&1
            fi
        else
            cp -rf $swarmTemplatesPath/docker/tls.yaml $proxyPath/dynamic/tls.yaml > /dev/null 2>&1
        fi
        chown -R 65532:65532 $proxyPath > /dev/null 2>&1
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml -f docker-traefik-https.yml up -d > /dev/null 2>&1 )
    else
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml up -d > /dev/null 2>&1 )
    fi
fi