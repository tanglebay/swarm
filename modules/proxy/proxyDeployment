#!/bin/bash
source $proxyModulePath/proxyConfigCheck

if [ "$TRAEFIK_PROTOCOL" = "https" ] && [ -z $TRAEFIK_ACME_EMAIL ] && [ "$TRAEFIK_SSL_RESOLVER" = "acme" ]; then
    TRAEFIK_ACME_EMAIL=$(whiptail --inputbox "\nPlease enter your e-mail address so that a certificate can be issued" 10 65 --title "Proxy [-] Deployment" 3>&1 1>&2 2>&3)
fi

{
    echo 0
    echo 20
    if [ ! -d $proxyPath ]; then
        mkdir -p $proxyPath/dynamic $proxyPath/certs > /dev/null 2>&1
        chown -R 65532:65532 $proxyPath > /dev/null 2>&1
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml pull > /dev/null 2>&1 )
    fi
    echo 40
    if [ "$TRAEFIK_PROTOCOL" = "https" ]; then
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml -f docker-traefik-https.yml down > /dev/null 2>&1 )
    else
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml down > /dev/null 2>&1 )
    fi
    echo 60
    cp -rf $swarmConfigsPath/docker-env.cfg $swarmDockerPath/.env > /dev/null 2>&1
    echo 80
    if [ "$TRAEFIK_PROTOCOL" = "https" ]; then
        if [ "$TRAEFIK_SSL_RESOLVER" = "acme" ]; then
            cp -rf $swarmTemplatesPath/docker/acme.yaml $proxyPath/dynamic/acme.yaml > /dev/null 2>&1
            sed -i 's~^email:.*~email: '$TRAEFIK_ACME_EMAIL'~g' $proxyPath/dynamic/acme.yaml
        fi
        if [ "$TRAEFIK_SSL_RESOLVER" = "custom" ]; then
            if [ ! -f "$proxyPath/dynamic/tls.yaml" ]; then
                cp -rf $swarmTemplatesPath/docker/tls_custom.yaml $proxyPath/dynamic/tls.yaml > /dev/null 2>&1
            fi
        else
            cp -rf $swarmTemplatesPath/docker/tls.yaml $proxyPath/dynamic/tls.yaml > /dev/null 2>&1
        fi
        chown -R 65532:65532 $proxyPath > /dev/null 2>&1
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml -f docker-traefik-https.yml up -d > /dev/null 2>&1 )
    else
        ( cd $swarmDockerPath ; docker compose -f docker-traefik.yml up -d > /dev/null 2>&1 )
    fi
    echo 100
} | whiptail --gauge "Please wait while the proxy will be deployed..." 6 65 0
whiptail --title "Proxy [-] Deployment" --msgbox "Proxy deployed successfully." 8 70 
